<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ecologist PDA + Desktop</title>

  <style>
    :root{
      --lab-bg: #061013;
      --lab-bg2:#08171b;
      --lab-panel:#0b1c21;
      --lab-line:#1a3942;
      --lab-text:#d7f3ff;
      --lab-muted:#85b6c9;

      --lab-accent:#58c7ff;
      --lab-accent2:#2f7fa3;

      --lab-warn:#ffd77a;
      --lab-good:#67e28a;
      --lab-grey:#b9c6cf;
      --lab-bad:#ff6b6b;

      --sys-font: 'Tahoma','MS Sans Serif','Segoe UI',system-ui,sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;

      --w95-bg:#c0c0c0;
      --w95-face:#dfdfdf;
      --w95-shadow:#808080;

      --w7-taskbar:#1b2a3d;
      --w7-taskbar-top:#314763;
      --w7-taskbar-bottom:#152235;
      --w7-window-border:#1a2e47;
      --w7-window-header-top:#3b6ca8;
      --w7-window-header-bottom:#24466d;
      --w7-window-header-inactive-top:#aeb8c3;
      --w7-window-header-inactive-bottom:#7c8896;
      --w7-window-body:#f0f4f8;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      height:100vh;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at top, #1a2328 0%, #07090b 55%, #020203 100%);
      font-family:var(--sys-font);
      color:var(--lab-text);
    }

    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      height:42px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      background:linear-gradient(180deg,#0c1115,#070b0e);
      border-bottom:1px solid #1b2522;
      z-index:999;
      font-family:var(--mono);
    }
    .brand{display:flex; gap:10px; align-items:center; color:#a3b7be; font-size:12px; letter-spacing:.08em; text-transform:uppercase;}
    .brand .dot{width:8px;height:8px;border-radius:99px;background:var(--lab-accent);box-shadow:0 0 12px rgba(88,199,255,.35);}
    .modeSwitch{display:flex; gap:8px; align-items:center;}
    .hint{color:#a0b3ba; font-size:11px; user-select:none; white-space:nowrap;}

    .btn{
      font-family:var(--mono);
      border:1px solid #2a3b36;
      background:#0b1216;
      color:#e6f6ff;
      padding:6px 10px;
      cursor:pointer;
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:#3f5b52;background:#0f1b20}

    .viewport{
      width:100%;
      height:calc(100vh - 42px);
      padding-top:42px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .pdaWrap{
      display:block;
      width:1240px;
      height:820px;
      position:relative;
    }
    .pda-chassis{
      position:absolute; inset:0;
      border-radius:32px;
      background:
        radial-gradient(circle at 55% 20%, rgba(255,255,255,0.09), transparent 58%),
        radial-gradient(circle at 40% 120%, rgba(88,199,255,0.1), transparent 65%),
        linear-gradient(180deg, #151f24, #040607 70%);
      box-shadow:
        0 30px 90px rgba(0,0,0,.75),
        inset 0 0 0 2px rgba(255,255,255,.03),
        inset 0 0 0 11px rgba(0,0,0,.55);
      z-index:0;
    }
    .pda-side{
      position:absolute;
      top:80px;
      bottom:80px;
      width:42px;
      border-radius:30px;
      background:
        repeating-linear-gradient(180deg, rgba(0,0,0,0.8) 0px, rgba(0,0,0,0.8) 4px, rgba(35,55,63,0.95) 4px, rgba(35,55,63,0.95) 6px);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.03), 0 0 32px rgba(0,0,0,0.9);
      z-index:1;
    }
    .pda-side-left{left:34px;}
    .pda-side-right{right:34px;}

    .pda-top-slot{
      position:absolute;
      left:140px;
      right:140px;
      top:40px;
      height:26px;
      border-radius:16px;
      background:linear-gradient(180deg, #050809, #020304);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.05),0 14px 30px rgba(0,0,0,0.8);
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 18px;
      gap:10px;
    }
    .top-slot-led{
      width:10px;height:10px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #bfeaff, #58c7ff);
      box-shadow:0 0 10px rgba(88,199,255,0.8);
    }
    .top-slot-label{
      font-family:var(--mono);
      font-size:10px;
      color:#8ca4ac;
      letter-spacing:.14em;
      text-transform:uppercase;
    }

    .pda-bottom-lights{
      position:absolute;
      left:140px;
      right:140px;
      bottom:38px;
      height:26px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 28px;
      z-index:1;
    }
    .pda-bottom-lights .pill{
      width:70px;height:12px;
      border-radius:999px;
      border:1px solid rgba(88,199,255,0.2);
      background:radial-gradient(circle at 30% 40%, rgba(88,199,255,0.7), rgba(0,0,0,0.8));
      box-shadow:0 0 12px rgba(88,199,255,0.7), inset 0 0 0 1px rgba(0,0,0,0.9);
      opacity:.7;
    }
    .pda-bottom-lights .pill.warn{
      border-color:rgba(255,215,122,0.8);
      background:radial-gradient(circle at 30% 40%, rgba(255,215,122,0.9), rgba(0,0,0,0.8));
      box-shadow:0 0 10px rgba(255,215,122,0.7), inset 0 0 0 1px rgba(0,0,0,0.9);
    }

    .pda-screen{
      position:absolute;
      left:102px;
      top:86px;
      width:980px;
      height:660px;
      border-radius:20px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      z-index:2;
      box-shadow:
        0 0 0 2px rgba(0,0,0,0.9),
        0 0 0 1px rgba(255,255,255,0.05),
        0 18px 40px rgba(0,0,0,0.9);
      background:
        radial-gradient(circle at 8% 10%, rgba(255,255,255,0.06), transparent 60%),
        radial-gradient(circle at 92% 90%, rgba(255,255,255,0.04), transparent 58%);
    }

    .pda-os-frame{
      position:relative;
      flex:1;
      border-radius:15px;
      overflow:hidden;
      background:
        radial-gradient(circle at 50% -30%, rgba(88,199,255,0.14), transparent 55%),
        linear-gradient(180deg, var(--lab-bg2), var(--lab-bg) 70%);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.8), 0 0 0 1px rgba(0,0,0,.85);
    }

    .screen-noise{
      position:absolute; inset:7px; border-radius:10px;
      pointer-events:none;
      opacity:0.16;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, transparent 1px, transparent 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.22) 0px, rgba(0,0,0,0.22) 1px, transparent 1px, transparent 5px);
      mix-blend-mode: soft-light;
      animation: noise-move 8s steps(9) infinite;
      z-index:30;
    }
    @keyframes noise-move{
      0%{background-position:0 0,0 0}
      50%{background-position:22px 18px,-16px 22px}
      100%{background-position:0 0,0 0}
    }
    .screen-vignette{
      position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(circle at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 45%, rgba(0,0,0,0.95) 100%);
      opacity:.14;
      z-index:20;
    }

    .syncOverlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .syncBox{
      padding:14px 18px;
      border-radius:10px;
      border:1px solid rgba(88,199,255,0.45);
      background:rgba(5,18,24,0.9);
      box-shadow:0 0 22px rgba(0,0,0,0.9);
      text-align:center;
      font-family:var(--mono);
      max-width:260px;
    }
    .syncSpinner{
      width:26px;height:26px;
      border-radius:50%;
      border:3px solid rgba(88,199,255,0.25);
      border-top-color:rgba(88,199,255,0.95);
      margin:0 auto 8px;
      animation: spin 0.8s linear infinite;
    }
    .syncTitle{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--lab-text);
    }
    .syncSub{
      font-size:10px;
      color:var(--lab-muted);
      margin-top:4px;
    }
    @keyframes spin{
      to{ transform:rotate(360deg); }
    }

    .title-bar{
      height:32px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 10px;
      background: linear-gradient(to right, rgba(6,34,45,1), rgba(5,18,24,1));
      border-bottom:1px solid rgba(0,0,0,.9);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .title-left{display:flex; gap:10px; align-items:center;}
    .title-icon{
      width:14px;height:14px;
      background: radial-gradient(circle at 40% 35%, rgba(88,199,255,0.9), rgba(7,25,33,0.95));
      border:1px solid rgba(88,199,255,0.25);
      box-shadow:0 0 10px rgba(88,199,255,0.18);
    }
    .titleText{display:flex; flex-direction:column; gap:1px}
    .titleText .main{font-weight:800; color:var(--lab-text);}
    .titleText .sub{font-size:10px; letter-spacing:.02em; text-transform:none; color:var(--lab-muted); font-family:var(--sys-font);}
    .title-right{display:flex; gap:10px; align-items:center; color:var(--lab-muted); font-family:var(--mono);}
    .zone-tag{
      padding:2px 8px;
      border:1px solid rgba(88,199,255,0.25);
      background: rgba(0,0,0,0.25);
      color:var(--lab-text);
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .zone-tag.user{
      border-color:rgba(88,199,255,0.25);
      color:var(--lab-text);
    }
    .zone-tag.admin{
      border-color:rgba(255,215,122,0.9);
      color:#ffd77a;
      box-shadow:0 0 8px rgba(255,215,122,0.45);
    }
    .icon-btn{
      width:20px;height:20px;
      border:1px solid rgba(88,199,255,0.20);
      background: rgba(0,0,0,0.25);
      cursor:pointer;
      color:var(--lab-text);
      font-size:12px;
      display:flex; align-items:center; justify-content:center;
    }
    .icon-btn:hover{filter:brightness(1.08)}
    .icon-btn:active{transform:translateY(1px)}

    .actionBar{
      height:28px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-top:1px solid #000;
      background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55));
      color:var(--lab-muted);
      font-size:10px;
      font-family:var(--mono);
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .uplinkBox{
      display:flex;
      align-items:center;
      gap:6px;
      font-family:var(--mono);
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .uplinkBars{
      font-size:15px;
      color:var(--lab-accent);
    }
    .uplinkLabel{
      color:var(--lab-muted);
    }

    .pda-home{
      position:relative;
      height:calc(100% - 32px - 28px);
      padding:10px;
    }
    .homeHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding:10px 10px 10px;
      border:1px solid rgba(88,199,255,0.14);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.8);
    }
    .homeHeader .left{display:flex; flex-direction:column; gap:4px;}
    .homeHeader .left b{letter-spacing:.12em; text-transform:uppercase; font-size:12px; font-family:var(--mono);}
    .homeHeader .left span{color:var(--lab-muted); font-size:10px;}
    .badge{
      padding:2px 8px;
      border:1px solid rgba(88,199,255,0.18);
      background: rgba(0,0,0,0.20);
      color:var(--lab-text);
      letter-spacing:.06em;
      font-family:var(--mono);
      font-size:10px;
    }

    .appsGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
    }
    .appTile{
      position:relative;
      border:1px solid rgba(88,199,255,0.14);
      background:
        radial-gradient(circle at var(--hx,50%) var(--hy,50%), rgba(88,199,255,0.20), transparent 60%),
        rgba(0,0,0,0.18);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.8);
      padding:10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      min-height:66px;
      transition:transform .07s ease, box-shadow .07s ease, border-color .07s ease, background .07s ease;
      overflow:hidden;
    }
    .appTile::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at var(--hx,50%) var(--hy,50%), rgba(255,255,255,0.10), transparent 65%);
      opacity:0;
      pointer-events:none;
      transition:opacity .08s ease;
      mix-blend-mode:screen;
    }
    .appTile:hover{
      transform:translateY(-1px) scale(1.01);
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,0.9),
        0 0 18px rgba(88,199,255,0.4);
      border-color:rgba(88,199,255,0.45);
    }
    .appTile:hover::after{opacity:1}
    .appTile:active{transform:translateY(0) scale(1.0)}
    .appTile .label{display:flex; flex-direction:column; gap:5px; position:relative; z-index:1;}
    .appTile .label b{font-size:12px; letter-spacing:.12em; text-transform:uppercase; font-family:var(--mono);}
    .appTile .label span{font-size:10px; color:var(--lab-muted);}
    .appTile .glyph{
      width:34px;height:34px;
      border:1px solid rgba(88,199,255,0.22);
      background: radial-gradient(circle at 35% 35%, rgba(88,199,255,0.5), rgba(0,0,0,0.35));
      position:relative;
      z-index:1;
    }

    .appWindow{
      position:absolute;
      inset:10px;
      border:1px solid rgba(88,199,255,0.14);
      background: linear-gradient(180deg, var(--lab-bg2), var(--lab-bg));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
      display:none;
      flex-direction:column;
      overflow:hidden;
      z-index:5;
    }
    .appTop{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      background: linear-gradient(to right, rgba(6,34,45,1), rgba(5,18,24,1));
      border-bottom:1px solid rgba(0,0,0,.9);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--lab-text);
      font-family:var(--mono);
    }
    .appTop .sub{color:var(--lab-muted); font-size:10px; letter-spacing:.06em; text-transform:none; font-family:var(--sys-font);}
    .appBody{flex:1; min-height:0; overflow:auto; padding:10px;}

    .panel{
      border:1px solid rgba(88,199,255,0.12);
      background: rgba(0,0,0,0.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
      padding:10px;
    }
    .panelTitle{
      display:flex; justify-content:space-between; align-items:center;
      margin:0 0 8px;
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--lab-muted);
      font-family:var(--mono);
    }

    .field{
      width:100%;
      height:28px;
      border:1px solid rgba(88,199,255,0.14);
      padding:5px 8px;
      font-size:12px;
      font-family:var(--sys-font);
      background: rgba(0,0,0,0.22);
      color:var(--lab-text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
    }
    .field-sm{
      height:24px;
      font-size:11px;
      padding:3px 6px;
    }
    textarea.field{height:auto; min-height:100px; resize:vertical; padding:8px}

    .glossBtn{
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(88,199,255,0.18);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
      padding:7px 10px;
      font-size:10px;
      color:var(--lab-text);
      text-transform:uppercase;
      letter-spacing:0.14em;
      cursor:pointer;
      font-family:var(--mono);
    }
    .glossBtn:hover{filter:brightness(1.08)}
    .glossBtn:active{transform:translateY(1px)}
    .glossBtn.primary{
      background: rgba(88,199,255,0.18);
      border-color: rgba(88,199,255,0.28);
    }
    .glossBtn.bigAction{
      padding:7px 16px;
      font-size:11px;
      letter-spacing:.18em;
      border-color:rgba(88,199,255,0.45);
      background:rgba(88,199,255,0.28);
      box-shadow:0 0 14px rgba(88,199,255,0.55), inset 0 0 0 1px rgba(0,0,0,0.9);
      color:#e9f8ff;
    }
    .glossBtn.closeBtn{
      border-color:rgba(255,107,107,0.6);
      color:#ffc8c8;
      background:rgba(40,0,0,0.6);
      box-shadow:0 0 10px rgba(255,107,107,0.5), inset 0 0 0 1px rgba(0,0,0,0.9);
    }
    .glossBtn.closeBtn:hover{
      filter:none;
      background:rgba(60,0,0,0.8);
    }

    .seg{
      display:inline-flex;
      border:1px solid rgba(88,199,255,0.16);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
      overflow:hidden;
      font-family:var(--mono);
    }
    .seg button{
      border:0;
      padding:6px 10px;
      background:transparent;
      color:var(--lab-muted);
      cursor:pointer;
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-family:var(--mono);
    }
    .seg button.active{
      color:var(--lab-text);
      background: rgba(88,199,255,0.16);
    }

    .dbLayout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:10px;
      height:100%;
      min-height:0;
    }
    .dbList{min-height:0; display:flex; flex-direction:column; gap:10px}
    .dbList .panel{flex:1; min-height:0; display:flex; flex-direction:column; gap:8px}
    .dbListScroll{
      flex:1; min-height:0; overflow:auto;
      border:1px solid rgba(88,199,255,0.10);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
    }

    .dbTable{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .dbTable th{
      position:sticky; top:0; z-index:2;
      text-align:left;
      padding:8px 8px;
      background: rgba(0,0,0,0.35);
      border-bottom:1px solid rgba(88,199,255,0.12);
      font-family:var(--mono);
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#bfeaff;
      vertical-align:bottom;
    }
    .thToggle{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .thToggle .miniBtn{
      padding:2px 6px;
      font-size:10px;
      letter-spacing:.10em;
      border:1px solid rgba(88,199,255,0.18);
      background: rgba(0,0,0,0.22);
      color:var(--lab-text);
      cursor:pointer;
      font-family:var(--mono);
    }
    .thToggle .miniBtn.active{background: rgba(88,199,255,0.18); border-color: rgba(88,199,255,0.28);}

    .dbTable td{
      padding:8px 8px;
      border-bottom:1px solid rgba(88,199,255,0.07);
      vertical-align:top;
    }
    .dbRow{
      cursor:pointer;
      transition:filter .08s ease;
    }
    .dbRow:hover{filter:brightness(1.07)}
    .dbRow.selected{
      outline:2px solid rgba(88,199,255,0.22);
      outline-offset:-2px;
    }

    .tagId{
      font-family:var(--mono);
      font-size:10px;
      color:var(--lab-text);
      border:1px solid rgba(88,199,255,0.22);
      background: rgba(0,0,0,0.22);
      padding:2px 8px;
      letter-spacing:.10em;
      white-space:nowrap;
      display:inline-block;
    }

    .repScore{
      font-family:var(--mono);
      font-size:12px;
      font-weight:800;
      letter-spacing:.06em;
      text-align:right;
      white-space:nowrap;
    }
    .repNeg{color:var(--lab-bad)}
    .repGrey{color:var(--lab-grey)}
    .repYel{color:var(--lab-warn)}
    .repGrn{color:var(--lab-good)}

    .wantedName{
      color:var(--lab-bad);
    }

    .profileGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .profileFull{grid-column:1/-1}

    .repControl{display:flex; gap:8px; align-items:center;}
    .repValue{
      width:120px; height:28px;
      border:1px solid rgba(88,199,255,0.14);
      background: rgba(0,0,0,0.22);
      color:var(--lab-text);
      font-family:var(--mono);
      text-align:right;
      padding:5px 8px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);
    }
    .repBtns{display:flex; flex-direction:column; gap:4px}
    .repBtn{
      width:26px;height:12px;
      border:1px solid rgba(88,199,255,0.14);
      background: rgba(0,0,0,0.20);
      cursor:pointer;
      color:var(--lab-text);
      font-family:var(--mono);
      font-size:10px;
      line-height:1;
    }

    .tradeLayout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:10px;
      height:100%;
      min-height:0;
    }
    .tradeHeaderRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:8px;
    }

    .modeBanner{
      padding:6px 10px;
      border:1px solid rgba(88,199,255,0.18);
      background: rgba(0,0,0,0.22);
      font-family:var(--mono);
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--lab-text);
      flex:1;
      min-width:240px;
    }
    .modeBanner b{color:#bfeaff}

    .tradeTable{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      color:var(--lab-text);
    }
    .tradeTable th{
      position:sticky; top:0; z-index:2;
      text-align:left;
      padding:8px 8px;
      background: rgba(0,0,0,0.35);
      border-bottom: 1px solid rgba(88,199,255,0.12);
      font-family:var(--mono);
      font-size:10px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:#bfeaff;
    }
    .tradeTable td{
      border-bottom:1px solid rgba(88,199,255,0.07);
      padding:7px 8px;
      vertical-align:top;
    }
    .tradeRow:hover{background:rgba(255,255,255,0.03)}
    .disabledItem{opacity:0.35; filter:grayscale(0.2);}
    .qtyPill{display:inline-flex; gap:8px; align-items:center}
    .qtyPill button{
      width:22px;height:22px;
      border:1px solid rgba(88,199,255,0.14);
      background: rgba(0,0,0,0.18);
      color:var(--lab-text);
      cursor:pointer;
      font-family:var(--mono);
    }
    .qtyPill span{min-width:22px; text-align:center; font-family:var(--mono)}

    .availChk{
      appearance:none;
      width:16px;
      height:16px;
      border-radius:3px;
      border:1px solid rgba(88,199,255,0.38);
      background:#020608;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,0.9);
      cursor:pointer;
    }
    .availChk:checked{
      background:radial-gradient(circle at 35% 35%, #bfeaff, #58c7ff);
      box-shadow:
        0 0 6px rgba(88,199,255,0.85),
        inset 0 0 0 1px rgba(0,0,0,0.9);
    }
    .availChk:disabled{
      opacity:0.45;
      cursor:default;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,0.9);
    }

    .bootCover{
      position:absolute; inset:0;
      background:#000;
      z-index:9999;
      display:flex; /* show immediately so home never flashes before boot */
      align-items:center;
      justify-content:center;
      flex-direction:column;
      font-family:var(--mono);
      color:#f4f4f4;
      padding:18px 20px;
    }
    .bootLog{
      position:relative;
      font-size:9px;
      line-height:1.0;
      max-width:90ch;
      white-space:pre;
      text-align:center;
      text-shadow: 0 0 10px rgba(180,235,255,0.7), 0 0 18px rgba(88,199,255,0.4);
      margin-bottom:10px;
      z-index:1;
    }
    .biosBar{position:relative;width:74%;height:10px;background:#111;border:1px solid #888;box-shadow: inset 0 0 4px #000;z-index:1;}
    .biosFill{height:100%;width:0%;background: linear-gradient(to right, #bfeaff, #ffffff);box-shadow: 0 0 10px rgba(255,255,255,0.35);}
    .biosStatus{margin-top:8px;font-size:11px;color:#cfcfcf;position:relative;z-index:1;}

    .desktop{
      display:none;
      width:100%;
      height:100%;
      position:relative;
      background:
        radial-gradient(circle at 20% 0%, #3a7bd5 0%, transparent 55%),
        radial-gradient(circle at 80% 100%, #00c6ff 0%, transparent 50%),
        linear-gradient(135deg,#0b2344,#071423 60%,#02060b 100%);
      overflow:hidden;
      font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color:#fff;
    }
    .deskIcons{
      position:absolute;
      top:14px; left:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      width:200px;
      font-size:13px;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
    }
    .icon{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      user-select:none;
      cursor:default;
    }
    .iconBox{
      width:38px;height:38px;
      border-radius:8px;
      background:radial-gradient(circle at 30% 20%, #ffffff, #74b4ff);
      box-shadow:0 0 6px rgba(0,0,0,.6);
    }
    .icon div:last-child{
      max-width:120px;
      text-align:center;
    }

    .taskbar{
      position:absolute; left:0; right:0; bottom:0;
      height:46px;
      background:linear-gradient(to top, var(--w7-taskbar-bottom), var(--w7-taskbar-top));
      border-top:1px solid rgba(255,255,255,0.15);
      box-shadow: 0 -1px 0 rgba(0,0,0,0.6), 0 -6px 14px rgba(0,0,0,0.7);
      display:flex;
      align-items:center;
      padding:4px 10px;
      gap:10px;
      color:#eaf2ff;
      font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      backdrop-filter:blur(6px);
    }
    .startBtn{
      height:38px;
      padding:0 14px;
      border-radius:26px;
      border:1px solid rgba(255,255,255,0.4);
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #d6f785 45%, #6bb634 80%),
        linear-gradient(to bottom, #aada57, #5f9d2b);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      user-select:none;
      color:#10360a;
      box-shadow:0 0 8px rgba(0,0,0,0.7), inset 0 0 3px rgba(255,255,255,0.5);
    }
    .startFlag{
      width:20px;height:20px;
      border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, #ffffff, #22a7f0 45%, #1362b3 70%);
      box-shadow:0 0 6px rgba(0,0,0,0.7);
    }

    .taskBtns{
      flex:1;
      display:flex;
      gap:6px;
      overflow:auto;
      padding:0 6px;
    }
    .taskBtn{
      min-width:160px;
      max-width:240px;
      height:34px;
      border-radius:4px;
      border:1px solid rgba(255,255,255,0.35);
      background:linear-gradient(to bottom, rgba(255,255,255,0.35), rgba(0,0,0,0.15));
      display:flex;
      align-items:center;
      padding:0 12px;
      gap:8px;
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
      color:#eef4ff;
      box-shadow:0 0 6px rgba(0,0,0,0.7);
      font-size:12px;
    }
    .taskBtn.active{
      background:linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.45));
      color:#12335c;
    }

    .clock{
      min-width:100px;
      height:34px;
      border-radius:4px;
      border:1px solid rgba(255,255,255,0.35);
      background:linear-gradient(to bottom, rgba(255,255,255,0.25), rgba(0,0,0,0.1));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      user-select:none;
      color:#eef4ff;
      box-shadow:0 0 4px rgba(0,0,0,0.7);
    }

    .win{
      position:absolute;
      width:760px;height:470px;
      background:var(--w7-window-body);
      border-radius:6px;
      border:1px solid var(--w7-window-border);
      box-shadow:0 12px 32px rgba(0,0,0,.55);
      display:flex; flex-direction:column;
      min-width:380px; min-height:260px;
      overflow:hidden;
    }
    .winTitle{
      height:28px;
      background:linear-gradient(to bottom, var(--w7-window-header-top), var(--w7-window-header-bottom));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 8px;
      font-size:13px;
      user-select:none;
      cursor:move;
      box-shadow:0 1px 0 rgba(255,255,255,0.4) inset;
    }
    .winTitle .titleText{display:flex; align-items:center; gap:8px}
    .miniIcon{
      width:16px;height:16px;
      border-radius:3px;
      background:radial-gradient(circle at 30% 20%, #ffffff, #5fb2ff);
      box-shadow:0 0 3px rgba(0,0,0,0.7);
    }
    .winButtons{display:flex; gap:4px}
    .winBtn{
      width:24px;height:20px;
      border-radius:3px;
      border:1px solid rgba(0,0,0,0.3);
      background:linear-gradient(to bottom, rgba(255,255,255,0.3), rgba(0,0,0,0.1));
      display:flex; align-items:center; justify-content:center;
      color:#000;
      font-size:12px;
      line-height:1;
      user-select:none;
      cursor:pointer;
    }
    .winBtn[data-act="close"]{
      background:linear-gradient(to bottom, #f68a8a, #b83838);
      color:#fff;
    }
    .winBtn[data-act="close"]:hover{
      filter:brightness(1.1);
    }
    .winBody{
      flex:1;
      padding:10px;
      overflow:auto;
      font-size:13px;
      color:#000;
      background:var(--w7-window-body);
    }

    .w95Panel{
      background:#f5f7fa;
      border-radius:3px;
      border:1px solid rgba(0,0,0,0.15);
      padding:8px;
      width:100%;
      box-shadow:0 0 3px rgba(0,0,0,0.08) inset;
    }
    .w95Field{
      background:#fff;
      border-radius:2px;
      border:1px solid rgba(0,0,0,0.25);
      padding:6px;
      width:100%;
      font-size:13px;
      outline:none;
    }
    .w95Label{font-size:12px; margin:0 0 4px 0}
    .w95List{
      background:#fff;
      border-radius:2px;
      border:1px solid rgba(0,0,0,0.25);
      padding:0;
      width:100%;
      max-height:260px;
      overflow:auto;
    }
    .w95Item{
      padding:8px 10px;
      border-bottom:1px solid #e0e7f0;
      cursor:default;
    }
    .w95Item:hover{background:#e8f0ff}
    .w95Item:last-child{border-bottom:none}
    .hide{display:none !important}

    #receiptHint{
      font-size:13px;
      font-family:var(--mono);
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--lab-accent);
      min-height:18px;
    }

    #authPin{
      margin-top:8px;
      background:rgba(0,0,0,0.5);
      border:1px solid rgba(88,199,255,0.45);
      color:var(--lab-text);
      text-align:center;
      font-family:var(--mono);
    }

    /* auth & error overlays */
    .syncOverlay .syncTitle{margin-bottom:2px;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <span>ECOLOGIST SYSTEM</span>
      <span class="hint">shared • role-gated</span>
    </div>
    <div class="modeSwitch">
      <span class="hint">Switch:</span>
      <button class="btn primary" id="btnPDA">PDA</button>
      <button class="btn" id="btnDESK">DESKTOP</button>
      <span class="hint">Ctrl+1 / Ctrl+2</span>
    </div>
  </div>

  <div class="viewport">
    <!-- PDA -->
    <div class="pdaWrap" id="pdaWrap">
      <div class="pda-chassis"></div>
      <div class="pda-side pda-side-left"></div>
      <div class="pda-side pda-side-right"></div>
      <div class="pda-top-slot">
        <div class="top-slot-label">ECO FIELD TERMINAL</div>
        <div class="top-slot-led"></div>
      </div>
      <div class="pda-bottom-lights">
        <div class="pill"></div>
        <div class="pill warn"></div>
        <div class="pill"></div>
      </div>

      <div class="pda-screen">
        <div class="pda-os-frame">
          <!-- BOOT -->
          <div class="bootCover" id="bootCover">
            <div class="bootLog" id="bootLog"></div>
            <div class="biosBar"><div class="biosFill" id="biosFill"></div></div>
            <div class="biosStatus" id="biosStatus">INITIALIZING...</div>
          </div>

          <!-- SYNC OVERLAY -->
          <div class="syncOverlay" id="syncOverlay">
            <div class="syncBox">
              <div class="syncSpinner"></div>
              <div class="syncTitle" id="syncTitle">UPLINK SYNC...</div>
              <div class="syncSub" id="syncSub">Talking to PRIPYAT SAT-NET...</div>
            </div>
          </div>

          <!-- ERROR OVERLAY -->
          <div class="syncOverlay" id="errorOverlay">
            <div class="syncBox">
              <div class="syncTitle" id="errorTitle">ERROR</div>
              <div class="syncSub" id="errorSub">Connection problem.</div>
              <button class="glossBtn" id="errorOkBtn" style="margin-top:8px;">OK</button>
            </div>
          </div>

          <!-- AUTH OVERLAY -->
          <div class="syncOverlay" id="authOverlay" style="display:none;">
            <div class="syncBox">
              <div class="syncTitle">ACCESS REQUIRED</div>
              <div class="syncSub">Enter ecologist access PIN.</div>
              <input class="field field-sm" id="authPin" type="password" maxlength="6" placeholder="••••" />
              <div style="margin-top:8px; display:flex; gap:6px; justify-content:center;">
                <button class="glossBtn primary" id="authBtn">ENTER</button>
              </div>
              <div id="authMsg" class="syncSub" style="margin-top:6px; color:#ff9f9f;"></div>
            </div>
          </div>

          <!-- TITLE BAR -->
          <div class="title-bar">
            <div class="title-left">
              <div class="title-icon"></div>
              <div class="titleText">
                <div class="main">ECO FIELD PDA</div>
                <div class="sub">Mobile research terminal</div>
              </div>
            </div>
            <div class="title-right">
              <span class="zone-tag user" id="accessTag">ACCESS: USER</span>
              <button class="icon-btn" id="btnReboot" title="Resync from sheet">⟲</button>
              <button class="icon-btn" id="btnGoDesk" title="Open Desktop">⧉</button>
              <span id="pdaClock">--:--:--</span>
            </div>
          </div>

          <!-- HOME -->
          <div class="pda-home" id="pdaHome">
            <div class="homeHeader">
              <div class="left">
                <b>HOME</b>
                <span>Open apps. Close to reduce clutter.</span>
              </div>
              <div class="right" style="display:flex; gap:8px; align-items:center;">
                <span class="badge" id="queueBadge">NOTES: 0</span>
                <span class="badge" id="receiptBadge">RECEIPTS: 0</span>
                <span class="badge" id="sessionBadge">SESSION: LOCAL</span>
              </div>
            </div>

            <div class="appsGrid">
              <div class="appTile" data-open="appDatabase">
                <div class="label"><b>Database</b><span>Stalker registry (shared)</span></div>
                <div class="glyph"></div>
              </div>
              <div class="appTile" data-open="appNotes">
                <div class="label"><b>Notes</b><span>Field notes → Desktop</span></div>
                <div class="glyph"></div>
              </div>
              <div class="appTile" data-open="appTrade">
                <div class="label"><b>Trade Menu</b><span>Prices + receipts</span></div>
                <div class="glyph"></div>
              </div>
              <div class="appTile" data-open="appSettings">
                <div class="label"><b>Settings</b><span>Role + device</span></div>
                <div class="glyph"></div>
              </div>
            </div>

            <!-- DATABASE APP -->
            <div class="appWindow" id="appDatabase">
              <div class="appTop">
                <div>DATABASE <span class="sub">stalker registry</span></div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="glossBtn primary" data-act="saveAll">Save to Database</button>
                  <button class="glossBtn closeBtn" data-close>Close</button>
                </div>
              </div>

              <div class="appBody">
                <div class="dbLayout">
                  <!-- LEFT PANEL -->
                  <div class="dbList">
                    <div class="panel">
                      <div class="panelTitle">
                        <span>List</span>
                        <span id="dbCount" style="font-family:var(--mono);">0 REC</span>
                      </div>

                      <input class="field" id="dbSearch" placeholder="Search name / id / task / notes" />

                      <div style="height:8px"></div>

                      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <div class="seg" id="dbStatusSeg">
                          <button class="active" data-status="all">All</button>
                          <button data-status="collab">Collab</button>
                          <button data-status="wanted">Wanted</button>
                        </div>
                      </div>

                      <div style="height:8px"></div>

                      <div class="dbListScroll">
                        <table class="dbTable">
                          <thead>
                            <tr>
                              <th style="width:72%;">
                                <div class="thToggle">
                                  <span>Name</span>
                                  <button class="miniBtn active" id="nameSortBtn">A→Z</button>
                                </div>
                              </th>
                              <th style="width:28%; text-align:right;">
                                <div class="thToggle" style="justify-content:flex-end;">
                                  <button class="miniBtn active" id="repSortBtn">REP↓</button>
                                  <span>Rep</span>
                                </div>
                              </th>
                            </tr>
                          </thead>
                          <tbody id="dbTbody"></tbody>
                        </table>
                      </div>

                      <div style="display:flex; justify-content:flex-start; margin-top:6px;">
                        <button class="glossBtn bigAction" id="dbAddBtn">+ ADD ENTRY</button>
                      </div>
                    </div>
                  </div>

                  <!-- RIGHT PANEL -->
                  <div class="panel" style="min-height:0; display:flex; flex-direction:column; gap:10px;">
                    <div class="panelTitle">
                      <span>Selected</span>
                      <span id="dbSelectedId" class="tagId">NONE</span>
                    </div>

                    <div class="profileGrid">
                      <div class="panel">
                        <div class="panelTitle"><span>Name</span></div>
                        <input class="field" id="pName" placeholder="Name (callsign optional)" />
                      </div>

                      <div class="panel">
                        <div class="panelTitle"><span>Status</span></div>
                        <div class="seg" id="pStatusSeg">
                          <button class="active" data-v="Collaborator">Collab</button>
                          <button data-v="Wanted">Wanted</button>
                        </div>
                      </div>

                      <div class="panel">
                        <div class="panelTitle"><span>Task</span></div>
                        <input class="field" id="pTask" placeholder="Task / role / assignment" />
                      </div>

                      <div class="panel">
                        <div class="panelTitle"><span>Reputation</span></div>
                        <div class="repControl">
                          <input class="repValue" id="pRep" value="0" readonly />
                          <div class="repBtns">
                            <button class="repBtn" id="repUp">▲</button>
                            <button class="repBtn" id="repDn">▼</button>
                          </div>
                          <div class="repScore repGrey" id="repScorePreview">0</div>
                        </div>
                      </div>

                      <div class="panel profileFull">
                        <div class="panelTitle"><span>Notes</span></div>
                        <textarea class="field" id="pNotes" placeholder="Shared notes. Factual + short."></textarea>
                      </div>
                    </div>

                    <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                      <button class="glossBtn" id="dbDeleteBtn">Delete</button>
                      <button class="glossBtn primary" id="dbApplyBtn">Apply Changes</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- NOTES APP -->
            <div class="appWindow" id="appNotes">
              <div class="appTop">
                <div>NOTES <span class="sub">shared capture</span></div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="glossBtn primary" data-act="saveAll">Save to Database</button>
                  <button class="glossBtn closeBtn" data-close>Close</button>
                </div>
              </div>
              <div class="appBody">
                <div class="panel">
                  <div class="panelTitle"><span>New Note</span><span>Desktop inbox</span></div>
                  <input class="field" id="noteTitle" placeholder="Title" />
                  <div style="height:8px"></div>
                  <textarea class="field" id="noteBody" placeholder="Write the note..."></textarea>
                  <div style="margin-top:8px; text-align:right;">
                    <button class="glossBtn primary" id="noteSendBtn">Queue Note</button>
                  </div>
                </div>

                <div style="height:10px"></div>

                <div class="panel">
                  <div class="panelTitle"><span>Recent</span><span id="noteCount">0</span></div>
                  <div id="noteList"></div>
                </div>
              </div>
            </div>

            <!-- TRADE APP -->
            <div class="appWindow" id="appTrade">
              <div class="appTop">
                <div>TRADE <span class="sub">prices + receipts</span></div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="glossBtn primary" data-act="saveAll">Save to Database</button>
                  <button class="glossBtn closeBtn" data-close>Close</button>
                </div>
              </div>

              <div class="appBody">
                <div class="tradeLayout">
                  <!-- LEFT SIDE -->
                  <div class="panel" style="min-height:0; display:flex; flex-direction:column;">
                    <div class="panelTitle">
                      <span>Price List</span>
                      <span id="tradeUpdated" style="font-family:var(--mono);">UPDATED: --</span>
                    </div>

                    <div class="tradeHeaderRow">
                      <div class="seg" id="tradeModeSeg">
                        <button class="active" data-mode="buy">BUY</button>
                        <button data-mode="sell">SELL</button>
                      </div>

                      <div class="modeBanner" id="modeBanner">
                        <b>BUYING FROM</b> stalker (we pay them)
                      </div>

                      <input class="field" id="tradeSearch" placeholder="Search item / category" style="flex:1; min-width:220px;" />
                      <button class="glossBtn" id="tradeClearQtyBtn">Clear</button>
                    </div>

                    <div style="flex:1; min-height:0; overflow:auto; border:1px solid rgba(88,199,255,0.10); background:rgba(0,0,0,0.18); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.85);">
                      <table class="tradeTable">
                        <thead>
                          <tr>
                            <th style="width:16%;">Cat</th>
                            <th>Item</th>
                            <th style="width:12%;">Price</th>
                            <th style="width:18%;">Qty</th>
                            <th style="width:10%;">Avail</th>
                            <th style="width:8%;">Del</th>
                          </tr>
                        </thead>
                        <tbody id="tradeTbody"></tbody>
                      </table>
                    </div>

                    <div style="margin-top:6px; display:flex; justify-content:flex-start;">
                      <button class="glossBtn bigAction" id="tradeAddItemBtn">+ ADD ITEM</button>
                    </div>
                  </div>

                  <!-- RIGHT SIDE -->
                  <div class="panel" style="display:flex; flex-direction:column; gap:10px;">
                    <div class="panelTitle">
                      <span>Receipt</span>
                      <span id="receiptTotalTag" style="font-family:var(--mono);">TOTAL: 0</span>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:4px;">
                      <span style="font-size:10px; letter-spacing:.12em; text-transform:uppercase;">Discount (SELL):</span>
                      <input class="field field-sm" id="discountInput" placeholder="% e.g. 10" style="width:80px; max-width:120px;" disabled />
                      <span style="font-size:10px; color:var(--lab-muted);">Only applied when selling to stalker</span>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <input class="field" id="receiptParty" list="partyList" placeholder="Counterparty (type name, pick from DB)" style="flex:1; min-width:220px;" />
                      <datalist id="partyList"></datalist>

                      <button class="glossBtn primary" id="tradeGenerateBtn">Generate</button>
                      <button class="glossBtn closeBtn" id="tradeSendReceiptBtn">Upload</button>
                    </div>

                    <div id="receiptHint">Set quantities and press GENERATE.</div>

                    <div class="panel" style="padding:10px; background:rgba(0,0,0,0.25); border:1px solid rgba(88,199,255,0.14);">
                      <div id="receiptBox" style="font-family:var(--mono); font-size:11px; white-space:pre-wrap; color:var(--lab-text); min-height:210px;">
                        No receipt generated.
                      </div>
                    </div>

                    <div style="font-size:10px; color:var(--lab-muted);">
                      Stored on <b>Desktop → Receipts</b>. Synced on “Save to Database”.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SETTINGS APP -->
            <div class="appWindow" id="appSettings">
              <div class="appTop">
                <div>SETTINGS <span class="sub">prototype</span></div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="glossBtn primary" data-act="saveAll">Save to Database</button>
                  <button class="glossBtn closeBtn" data-close>Close</button>
                </div>
              </div>

              <div class="appBody">
                <div class="panel">
                  <div class="panelTitle"><span>Access Level</span><span>visual only; real via PIN</span></div>
                  <div class="seg" id="accessSeg">
                    <button data-role="user" class="active">User</button>
                    <button data-role="admin">Admin</button>
                  </div>
                </div>

                <div style="height:10px"></div>

                <div class="panel">
                  <div class="panelTitle"><span>Boot</span><span>preview</span></div>
                  <button class="glossBtn" id="settingsBootBtn">Re-run Boot</button>
                </div>

                <div style="height:10px"></div>

                <div class="panel">
                  <div class="panelTitle"><span>Rules</span><span>shared</span></div>
                  <div style="font-size:12px; line-height:1.45; color:var(--lab-text);">
                    • Notes are shared (no private notes).<br/>
                    • Database: users can add / edit. Delete is <b>admin</b>-only.<br/>
                    • Trade items: <b>Admins</b> can add / toggle availability / remove.<br/>
                    • Buy price is what you pay stalkers; sell price is what stalkers pay you.<br/>
                    • Buy must be lower than sell when both are set.<br/>
                    • Items may be <b>buy-only</b>, <b>sell-only</b> or both (based on prices).<br/>
                    • Receipts go to <b>Desktop → Receipts</b>, synced on “Save to Database”.<br/>
                    • “Save to Database” appends new rows; no overwriting.<br/>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- FOOTER -->
          <div class="actionBar">
            <div>ACTIVITY: <b id="pdaStatus">BOOT</b></div>
            <div>STATUS: <b id="pdaConnStatus">LOCAL</b></div>
            <div class="uplinkBox">
              <span class="uplinkBars" id="uplinkBars">▂▁▁▁</span>
              <span class="uplinkLabel">Uplink: PRIPYAT SAT-NET <span id="uplinkPercent">24%</span></span>
            </div>
          </div>

          <div class="screen-vignette"></div>
          <div class="screen-noise"></div>
        </div>
      </div>
    </div>

    <!-- DESKTOP -->
    <div class="desktop" id="desktop">
      <div class="deskIcons">
        <div class="icon" data-open="reports"><div class="iconBox"></div><div>Reports</div></div>
        <div class="icon" data-open="receipts"><div class="iconBox"></div><div>Receipts</div></div>
        <div class="icon" data-open="intel"><div class="iconBox"></div><div>Intel (Encyclopaedia)</div></div>
        <div class="icon" data-open="personnel"><div class="iconBox"></div><div>Personnel</div></div>
      </div>

      <div id="windows"></div>

      <div class="taskbar">
        <div class="startBtn"><div class="startFlag"></div><div>Start</div></div>
        <div class="taskBtns" id="taskBtns"></div>
        <div class="clock" id="deskClock">--:--</div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // IMPORTANT: keep this as your current web app URL
      const UPLINK_URL = "https://script.google.com/macros/s/AKfycbxLdqPF_leR-hvp2Q-OdnPiCzAmqlDlMfcE9QQ6BIgsUA3KbHm_nhgakxQ8V-s6gkVY/exec";

      // Sheets expected:
      //  - Auth      (key, value) with user_pin / admin_pin
      //  - Stalkers  (timestamp,eventType,id,name,status,rep,task,notes)
      //  - Trade     (timestamp,eventType,id,category,item,buyPrice,sellPrice,enabled,canBuy,canSell)
      //  - Notes     (timestamp,title,body)
      //  - Receipts  (serial,timestamp,party,mode,baseTotal,discount,total,body)

      function $(sel){ return document.querySelector(sel); }
      function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
      function pad2(n){ n = parseInt(n,10); if(isNaN(n)) n=0; return (n<10?"0":"")+n; }

      function escapeHtml(s){
        if(s == null) return "";
        return String(s).replace(/[&<>"']/g, function(m){
          return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m];
        });
      }

      function nowClock(){
        const d = new Date();
        return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
      }
      function stamp(){
        const d = new Date();
        return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+" "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
      }

      function repClass(rep){
        if(rep < 0) return "repNeg";
        if(rep >= 800) return "repGrn";
        if(rep >= 500) return "repYel";
        return "repGrey";
      }
      function repRowBg(rep){
        if(rep < 0) return "rgba(255,107,107,0.12)";
        if(rep >= 800) return "rgba(103,226,138,0.12)";
        if(rep >= 500) return "rgba(255,215,122,0.12)";
        return "rgba(185,198,207,0.08)";
      }

      let AUTH_PINS = { user: "2227", admin: "1313" }; // fallback so PIN screen works if Auth sheet missing

      const state = {
        mode: "pda",
        role: "user",
        authenticated: false,

        stalkers: [],
        selectedStalkerId: null,
        dbStatusFilter: "all",
        primarySort: "rep",
        nameSortAsc: true,
        repSortDesc: true,

        tradeMode: "buy",
        trade: [],
        tradeQty: {},
        tradeAddDraft: null,

        notesQueue: [],
        receiptsQueue: [],
        lastReceipt: null,
        receiptSerial: 1,

        winZ: 10,
        desktopWins: {},
        desktopTasks: {},

        dirty: { stalkers:false, trade:false, notes:false, receipts:false },

        pendingStalkerEvents: [],
        pendingTradeEvents: []
      };

      function setConnStatus(txt){
        const el = $("#pdaConnStatus");
        if(el) el.textContent = txt;
      }

      function markDirty(kind){
        if(kind && state.dirty && state.dirty.hasOwnProperty(kind)){
          state.dirty[kind] = true;
        }
        const st = $("#pdaStatus");
        if(st) st.textContent = "UNSAVED CHANGES";
      }

      function clearDirty(){
        state.dirty = { stalkers:false, trade:false, notes:false, receipts:false };
        const st = $("#pdaStatus");
        if(st) st.textContent = "READY";
      }

      function updateBadges(){
        $("#queueBadge").textContent   = "NOTES: "    + state.notesQueue.length;
        $("#receiptBadge").textContent = "RECEIPTS: " + state.receiptsQueue.length;
      }

      function setMode(mode){
        if(mode === "desktop" && !state.authenticated){
          return;
        }
        state.mode = mode;
        $("#pdaWrap").style.display = (mode === "pda") ? "block" : "none";
        $("#desktop").style.display = (mode === "desktop") ? "block" : "none";
        $("#btnPDA").classList.toggle("primary", mode === "pda");
        $("#btnDESK").classList.toggle("primary", mode === "desktop");
      }

      function setRole(role){
        state.role = role;
        const tag = $("#accessTag");
        if(tag){
          tag.textContent = "ACCESS: " + role.toUpperCase();
          tag.classList.remove("admin","user");
          tag.classList.add(role === "admin" ? "admin" : "user");
        }
        $("#tradeAddItemBtn").style.display = (role === "admin") ? "inline-flex" : "none";
        $("#dbDeleteBtn").style.display     = (role === "admin") ? "inline-flex" : "none";
        renderTrade();
      }

      function closeAllApps(){
        $all(".appWindow").forEach(w => w.style.display = "none");
      }
      function openApp(id){
        closeAllApps();
        const w = $("#"+id);
        if(w) w.style.display = "flex";
        const st = $("#pdaStatus");
        if(st) st.textContent = "IN APP";
      }

      function showSyncOverlay(kind,message){
        const ov = $("#syncOverlay");
        if(!ov) return;
        ov.style.display = "flex";
        $("#syncTitle").textContent = (kind==="saving" ? "UPLINK SYNC..." : "RESYNCING...");
        $("#syncSub").textContent = message || "Talking to PRIPYAT SAT-NET...";
      }
      function hideSyncOverlay(){
        const ov = $("#syncOverlay");
        if(ov) ov.style.display = "none";
      }

      function showErrorOverlay(title,message){
        const ov = $("#errorOverlay");
        if(!ov) return;
        ov.style.display = "flex";
        $("#errorTitle").textContent = title || "ERROR";
        $("#errorSub").textContent   = message || "";
      }
      function hideErrorOverlay(){
        const ov = $("#errorOverlay");
        if(ov) ov.style.display = "none";
      }

      function showAuthOverlay(){
        const ov = $("#authOverlay");
        if(ov){
          ov.style.display = "flex";
          const p = $("#authPin");
          if(p) p.focus();
        }
        const st = $("#pdaStatus");
        if(st) st.textContent = "LOCKED";
      }
      function hideAuthOverlay(){
        const ov = $("#authOverlay");
        if(ov) ov.style.display = "none";
      }

      function handleAuth(){
        const pinField = $("#authPin");
        const msg = $("#authMsg");
        if(!pinField) return;
        const v = (pinField.value || "").trim();
        if(!v){
          if(msg) msg.textContent = "Enter PIN.";
          return;
        }
        if(v === AUTH_PINS.admin){
          state.authenticated = true;
          setRole("admin");
          hideAuthOverlay();
          if(msg) msg.textContent = "";
          $("#pdaStatus").textContent = "READY";
        }else if(v === AUTH_PINS.user){
          state.authenticated = true;
          setRole("user");
          hideAuthOverlay();
          if(msg) msg.textContent = "";
          $("#pdaStatus").textContent = "READY";
        }else{
          if(msg) msg.textContent = "Invalid PIN.";
          pinField.select();
        }
      }

      function nextStkId(){
        let max = 0;
        state.stalkers.forEach(s => {
          const n = parseInt(String(s.id||"").replace("STK-",""),10);
          if(!isNaN(n) && n>max) max=n;
        });
        const next = max+1;
        let num = String(next);
        while(num.length<4) num="0"+num;
        return "STK-"+num;
      }
      function nextTradeId(){
        let max = 0;
        state.trade.forEach(t => {
          const n = parseInt(String(t.id||"").replace("TRD-",""),10);
          if(!isNaN(n) && n>max) max=n;
        });
        const next = max+1;
        let num = String(next);
        while(num.length<4) num="0"+num;
        return "TRD-"+num;
      }

      function rebuildPartyList(){
        const dl = $("#partyList");
        if(!dl) return;
        dl.innerHTML = "";
        const names = [];
        state.stalkers.forEach(s => {
          const n = (s.name || "").trim();
          if(n && !names.includes(n)) names.push(n);
        });
        names.sort();
        names.forEach(n => {
          const opt = document.createElement("option");
          opt.value = n;
          dl.appendChild(opt);
        });
      }

      function sortStalkers(arr){
        const list = arr.slice();
        const primary = state.primarySort === "name" ? "name" : "rep";
        list.sort((a,b) => {
          if(primary === "name"){
            const an = (a.name||"").toLowerCase();
            const bn = (b.name||"").toLowerCase();
            if(an < bn) return state.nameSortAsc ? -1 : 1;
            if(an > bn) return state.nameSortAsc ? 1 : -1;
            const ar = a.rep||0, br = b.rep||0;
            return br-ar;
          }else{
            const ar2 = a.rep||0, br2 = b.rep||0;
            if(ar2 < br2) return state.repSortDesc ? 1 : -1;
            if(ar2 > br2) return state.repSortDesc ? -1 : 1;
            const an2 = (a.name||"").toLowerCase();
            const bn2 = (b.name||"").toLowerCase();
            if(an2 < bn2) return -1;
            if(an2 > bn2) return 1;
            return 0;
          }
        });
        return list;
      }

      function setSegActive(segEl, value, attrName){
        if(!segEl) return;
        const btns = Array.prototype.slice.call(segEl.querySelectorAll("button"));
        btns.forEach(b => {
          const v = b.getAttribute(attrName);
          b.classList.toggle("active", v === value);
        });
      }

      function renderDbList(){
        const q = ($("#dbSearch").value || "").toLowerCase();
        const filter = state.dbStatusFilter;

        let items = state.stalkers.filter(s => {
          const hay = (s.id+" "+s.name+" "+s.task+" "+s.notes).toLowerCase();
          const okQ = !q || hay.indexOf(q) !== -1;
          let okF = true;
          if(filter === "collab") okF = (s.status === "Collaborator");
          else if(filter === "wanted") okF = (s.status === "Wanted");
          return okQ && okF;
        });

        items = sortStalkers(items);
        $("#dbCount").textContent = items.length + " REC";

        const tb = $("#dbTbody");
        tb.innerHTML = "";
        if(items.length === 0){
          tb.innerHTML = '<tr><td colspan="2" style="padding:10px; color:var(--lab-muted);">No matches.</td></tr>';
          return;
        }

        items.forEach(s2 => {
          const tr = document.createElement("tr");
          tr.className = "dbRow" + (s2.id === state.selectedStalkerId ? " selected" : "");
          tr.style.background = repRowBg(s2.rep || 0);

          const nameClass = (s2.status === "Wanted") ? 'wantedName' : '';

          tr.innerHTML =
            '<td>' +
              '<div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">' +
                '<div style="min-width:0;">' +
                  '<div style="font-weight:700; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' +
                    '<span class="'+nameClass+'">'+escapeHtml(s2.name || "(unnamed)")+'</span>' +
                  '</div>' +
                  '<div style="font-size:10px; color:var(--lab-muted); font-family:var(--mono); letter-spacing:.05em; margin-top:3px;">' +
                    '<span class="tagId">'+escapeHtml(s2.id)+'</span>' +
                    '<span style="margin-left:8px;">'+escapeHtml(s2.status)+'</span>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</td>' +
            '<td style="text-align:right;">' +
              '<div class="repScore '+repClass(s2.rep||0)+'">'+escapeHtml(s2.rep||0)+'</div>' +
            '</td>';

          tr.addEventListener("click", () => {
            state.selectedStalkerId = s2.id;
            renderDbList();
            loadProfile(s2.id);
          });

          tb.appendChild(tr);
        });
      }

      function loadProfile(id){
        const s = state.stalkers.find(x => x.id === id);
        if(!s){
          $("#dbSelectedId").textContent = "NONE";
          $("#pName").value = "";
          $("#pTask").value = "";
          $("#pNotes").value = "";
          $("#pRep").value = "0";
          const pv0 = $("#repScorePreview");
          pv0.textContent = "0";
          pv0.className = "repScore repGrey";
          setSegActive($("#pStatusSeg"), "Collaborator", "data-v");
          return;
        }

        $("#dbSelectedId").textContent = s.id;
        $("#pName").value  = s.name || "";
        $("#pTask").value  = s.task || "";
        $("#pNotes").value = s.notes || "";
        $("#pRep").value   = String(s.rep || 0);
        const pv = $("#repScorePreview");
        pv.textContent = String(s.rep || 0);
        pv.className = "repScore " + repClass(s.rep || 0);

        setSegActive($("#pStatusSeg"), s.status || "Collaborator", "data-v");
        rebuildPartyList();
      }

      function dbAddEntry(){
        const id = nextStkId();
        const entry = { id:id, name:"", status:"Collaborator", task:"", rep:0, notes:"" };
        state.stalkers.unshift(entry);
        state.selectedStalkerId = id;
        renderDbList();
        loadProfile(id);
      }

      function queueStalkerEvent(ev){
        // keep latest per id
        state.pendingStalkerEvents = state.pendingStalkerEvents.filter(x => x.data.id !== ev.data.id);
        state.pendingStalkerEvents.push(ev);
        markDirty("stalkers");
      }

      function dbApply(){
        if(!state.selectedStalkerId){
          alert("Select an entry first.");
          return;
        }
        const s = state.stalkers.find(x => x.id === state.selectedStalkerId);
        if(!s) return;

        const statusBtn = $("#pStatusSeg button.active");
        const statusVal = statusBtn ? (statusBtn.getAttribute("data-v") || "Collaborator") : "Collaborator";

        s.name  = ($("#pName").value || "").trim();
        s.task  = ($("#pTask").value || "").trim();
        s.notes = ($("#pNotes").value || "").trim();
        s.rep   = parseInt($("#pRep").value || "0",10) || 0;
        s.status = statusVal;

        const pv = $("#repScorePreview");
        pv.textContent = String(s.rep);
        pv.className = "repScore " + repClass(s.rep || 0);

        queueStalkerEvent({
          eventType: "UPSERT",
          data: {
            id: s.id,
            name: s.name,
            status: s.status,
            rep: s.rep,
            task: s.task,
            notes: s.notes
          }
        });

        rebuildPartyList();
        renderDbList();

        const st = $("#pdaStatus");
        if(st){ st.textContent = "SAVED (LOCAL)"; setTimeout(()=>{ if(st.textContent==="SAVED (LOCAL)") st.textContent="UNSAVED CHANGES"; }, 800); }
      }

      function dbDelete(){
        if(state.role !== "admin"){
          alert("ADMIN ONLY: deleting entries.");
          return;
        }
        if(!state.selectedStalkerId){
          alert("Select an entry first.");
          return;
        }
        const entry = state.stalkers.find(x => x.id === state.selectedStalkerId);
        if(!entry) return;
        if(!confirm(`Delete ${entry.id} (${entry.name || "no name"}) from database?`)) return;

        const id = state.selectedStalkerId;
        state.stalkers = state.stalkers.filter(x => x.id !== id);
        state.selectedStalkerId = null;

        queueStalkerEvent({
          eventType: "DELETE",
          data: { id:id }
        });

        rebuildPartyList();
        renderDbList();
        loadProfile(null);
      }

      function renderNotes(){
        const list = $("#noteList");
        $("#noteCount").textContent = state.notesQueue.length+" REC";
        list.innerHTML = "";
        if(state.notesQueue.length === 0){
          list.innerHTML = '<div style="padding:8px; color:var(--lab-muted); font-size:12px;">No notes yet.</div>';
          return;
        }
        const slice = state.notesQueue.slice(-10).reverse();
        slice.forEach(n => {
          const div = document.createElement("div");
          div.className = "panel";
          div.style.marginBottom = "8px";
          div.innerHTML =
            '<div class="panelTitle"><span>'+escapeHtml(n.title || "NOTE")+'</span><span>'+escapeHtml(n.time)+'</span></div>'+
            '<div style="font-size:12px; color:var(--lab-text); white-space:pre-wrap;">'+escapeHtml(n.body || "")+'</div>';
          list.appendChild(div);
        });
      }

      function sendNoteToDesktop(){
        const title = ($("#noteTitle").value || "").trim();
        const body  = ($("#noteBody").value || "").trim();
        if(!body){
          alert("Write a note first.");
          return;
        }
        const note = {
          kind:"note",
          time: stamp(),
          title: title || "Field Note",
          body: body,
          _unsynced:true
        };
        state.notesQueue.push(note);
        $("#noteTitle").value = "";
        $("#noteBody").value  = "";
        updateBadges();
        renderNotes();
        markDirty("notes");
      }

      function supportsMode(item, mode){
        if(mode === "buy")  return item.enabled && item.canBuy && item.buy != null && !isNaN(item.buy);
        if(mode === "sell") return item.enabled && item.canSell && item.sell != null && !isNaN(item.sell);
        return true;
      }

      function setTradeMode(mode){
        state.tradeMode = mode;
        $all("#tradeModeSeg button").forEach(b => {
          b.classList.toggle("active", b.getAttribute("data-mode") === mode);
        });
        $("#modeBanner").innerHTML =
          (mode === "buy")
          ? "<b>BUYING FROM</b> stalker (we pay them)"
          : "<b>SELLING TO</b> stalker (they pay us)";

        const discFld = $("#discountInput");
        if(discFld){
          if(mode === "sell") discFld.removeAttribute("disabled");
          else discFld.setAttribute("disabled","disabled");
        }

        renderTrade();
        $("#receiptHint").textContent = "Set quantities and press GENERATE.";
      }

      function queueTradeEvent(ev){
        state.pendingTradeEvents = state.pendingTradeEvents.filter(x => x.data.id !== ev.data.id);
        state.pendingTradeEvents.push(ev);
        markDirty("trade");
      }

      function renderTrade(){
        $("#tradeUpdated").textContent = "UPDATED: "+(new Date().toLocaleDateString());
        const q = ($("#tradeSearch").value || "").toLowerCase();
        const tbody = $("#tradeTbody");
        tbody.innerHTML = "";

        let items = state.trade.filter(t => {
          const hay = (t.cat+" "+t.item).toLowerCase();
          return !q || hay.indexOf(q) !== -1;
        });

        if(items.length === 0 && !state.tradeAddDraft){
          tbody.innerHTML = '<tr><td colspan="6" style="padding:10px; color:var(--lab-muted);">No matches.</td></tr>';
        }

        const mode = state.tradeMode;

        items.forEach(it => {
          const qtyVal = state.tradeQty[it.id] || 0;
          const usable = supportsMode(it, mode);
          const price = (mode === "buy" ? it.buy : it.sell);
          const priceText = (usable ? escapeHtml(price) : "—");

          const rowClass = "tradeRow" + (usable ? "" : " disabledItem");

          let delCell;
          if(state.role === "admin"){
            delCell = '<button class="glossBtn" style="padding:5px 8px; letter-spacing:.08em;" data-act="remove" data-id="'+it.id+'">DEL</button>';
          }else{
            delCell = '<span style="color:var(--lab-muted); font-family:var(--mono);">—</span>';
          }

          let availCell;
          if(state.role === "admin"){
            availCell = '<input class="availChk" type="checkbox" data-act="toggle" data-id="'+it.id+'" '+(it.enabled ? "checked":"")+' />';
          }else{
            availCell = '<input class="availChk" type="checkbox" '+(it.enabled ? "checked":"")+' disabled />';
          }

          const qtyDisabled = usable ? "" : "disabled";

          const tr = document.createElement("tr");
          tr.className = rowClass;
          tr.innerHTML =
            '<td>'+escapeHtml(it.cat || "")+'</td>'+
            '<td><b>'+escapeHtml(it.item || "")+'</b><div style="font-size:10px;color:var(--lab-muted);font-family:var(--mono); letter-spacing:.05em;">'+escapeHtml(it.id)+'</div></td>'+
            '<td>'+priceText+'</td>'+
            '<td><div class="qtyPill">'+
              '<button data-act="inc" data-id="'+it.id+'" '+qtyDisabled+'>+</button>'+
              '<span id="qty-'+it.id+'">'+qtyVal+'</span>'+
              '<button data-act="dec" data-id="'+it.id+'" '+qtyDisabled+'>-</button>'+
            '</div></td>'+
            '<td style="text-align:center;">'+availCell+'</td>'+
            '<td>'+delCell+'</td>';
          tbody.appendChild(tr);
        });

        // add-row draft
        if(state.role === "admin" && state.tradeAddDraft){
          const draft = state.tradeAddDraft;
          const trDraft = document.createElement("tr");
          trDraft.className = "tradeRow";

          const cats = [];
          state.trade.forEach(t => {
            const c = (t.cat || "").trim();
            if(c && !cats.includes(c)) cats.push(c);
          });
          cats.sort();
          let opts = '<option value="">Category…</option>';
          cats.forEach(c => { opts += '<option value="'+escapeHtml(c)+'">'+escapeHtml(c)+'</option>'; });

          trDraft.innerHTML =
            '<td>'+
              '<select class="field field-sm" data-field="catSelect">'+opts+'</select>'+
              '<input class="field field-sm" data-field="catCustom" placeholder="Custom category (optional)" style="margin-top:4px;" />'+
            '</td>'+
            '<td><input class="field field-sm" data-field="item" placeholder="Item name" /></td>'+
            '<td>'+
              '<div style="display:flex; flex-direction:column; gap:4px;">'+
                '<input class="field field-sm" data-field="buy"  placeholder="Buy ₽" />'+
                '<input class="field field-sm" data-field="sell" placeholder="Sell ₽" />'+
              '</div>'+
            '</td>'+
            '<td style="text-align:center; font-size:11px; color:var(--lab-muted);">—</td>'+
            '<td style="text-align:center;"><input class="availChk" type="checkbox" data-field="enabled" checked /></td>'+
            '<td>'+
              '<div style="display:flex; flex-direction:column; gap:4px;">'+
                '<button class="glossBtn" style="padding:4px 6px; font-size:10px;" data-act="draft-save">Save</button>'+
                '<button class="glossBtn" style="padding:4px 6px; font-size:10px;" data-act="draft-cancel">Cancel</button>'+
              '</div>'+
            '</td>';

          tbody.appendChild(trDraft);

          const catSel    = trDraft.querySelector('[data-field="catSelect"]');
          const catCustom = trDraft.querySelector('[data-field="catCustom"]');
          const itemInp   = trDraft.querySelector('[data-field="item"]');
          const buyInp    = trDraft.querySelector('[data-field="buy"]');
          const sellInp   = trDraft.querySelector('[data-field="sell"]');
          const enChk     = trDraft.querySelector('[data-field="enabled"]');

          const saveBtn   = trDraft.querySelector('[data-act="draft-save"]');
          const cancelBtn = trDraft.querySelector('[data-act="draft-cancel"]');

          saveBtn.onclick = function(){
            const cat = (catCustom.value || "").trim() || (catSel.value || "").trim();
            const item = (itemInp.value || "").trim();
            if(!cat || !item){
              alert("Category and item name are required.");
              return;
            }
            const buyVal  = buyInp.value.trim();
            const sellVal = sellInp.value.trim();

            let buy  = null;
            let sell = null;
            if(buyVal !== ""){
              buy = parseInt(buyVal,10);
              if(isNaN(buy)){ alert("Invalid buy price."); return; }
            }
            if(sellVal !== ""){
              sell = parseInt(sellVal,10);
              if(isNaN(sell)){ alert("Invalid sell price."); return; }
            }
            if(buy === null && sell === null){
              alert("Set at least a buy or sell price.");
              return;
            }
            if(buy !== null && sell !== null && !(buy < sell)){
              alert("Buy must be LOWER than sell when both are set.");
              return;
            }
            const canBuy  = (buy !== null);
            const canSell = (sell !== null);

            const obj = {
              id: draft.id,
              cat: cat,
              item: item,
              buy: buy,
              sell: sell,
              enabled: enChk.checked,
              canBuy: canBuy,
              canSell: canSell
            };
            state.trade.push(obj);
            state.tradeAddDraft = null;
            queueTradeEvent({ eventType:"UPSERT", data:obj });
            renderTrade();
          };

          cancelBtn.onclick = function(){
            state.tradeAddDraft = null;
            renderTrade();
          };
        }

        // qty / delete
        $all('#tradeTbody [data-act="inc"], #tradeTbody [data-act="dec"], #tradeTbody [data-act="remove"]').forEach(el => {
          const act = el.getAttribute("data-act");
          const id  = el.getAttribute("data-id");
          el.onclick = function(){
            if(act === "inc" || act === "dec"){
              const item = state.trade.find(t => t.id === id);
              if(!item || !supportsMode(item,state.tradeMode)) return;
              const cur = state.tradeQty[id] || 0;
              const next = (act === "inc") ? cur+1 : Math.max(0,cur-1);
              state.tradeQty[id] = next;
              const span = $("#qty-"+id);
              if(span) span.textContent = String(next);
              return;
            }
            if(act === "remove"){
              if(state.role !== "admin"){
                alert("ADMIN ONLY.");
                return;
              }
              const item2 = state.trade.find(t => t.id === id);
              if(!item2) return;
              if(!confirm("Remove "+item2.item+" from trade menu?")) return;
              delete state.tradeQty[id];
              state.trade = state.trade.filter(t => t.id !== id);
              queueTradeEvent({ eventType:"DELETE", data:{ id:id } });
              renderTrade();
              return;
            }
          };
        });

        // availability toggles
        $all('#tradeTbody input[type="checkbox"][data-act="toggle"]').forEach(chk => {
          chk.onchange = function(){
            if(state.role !== "admin"){
              chk.checked = !chk.checked;
              return;
            }
            const id = chk.getAttribute("data-id");
            const item = state.trade.find(t => t.id === id);
            if(!item) return;
            item.enabled = chk.checked;
            if(!item.enabled) state.tradeQty[id] = 0;
            queueTradeEvent({ eventType:"UPSERT", data:item });
            renderTrade();
          };
        });
      }

      function clearTradeQty(){
        state.tradeQty = {};
        $("#receiptBox").textContent = "No receipt generated.";
        $("#receiptTotalTag").textContent = "TOTAL: 0";
        $("#receiptHint").textContent = "Set quantities and press GENERATE.";
        state.lastReceipt = null;
        renderTrade();
      }

      function startTradeAddRow(){
        if(state.role !== "admin"){
          alert("ADMIN ONLY: adding trade items.");
          return;
        }
        state.tradeAddDraft = { id: nextTradeId() };
        renderTrade();
      }

      function generateReceipt(){
        const mode  = state.tradeMode;
        const party = ($("#receiptParty").value || "").trim();
        if(!party){
          alert("Add a counterparty (pick from the list).");
          return null;
        }

        const entries = [];
        for(const id in state.tradeQty){
          if(Object.prototype.hasOwnProperty.call(state.tradeQty,id)){
            const q = state.tradeQty[id] || 0;
            if(q > 0) entries.push({id:id, qty:q});
          }
        }
        if(entries.length === 0){
          alert("Select at least one item and quantity.");
          return null;
        }

        let discount = 0;
        if(mode === "sell"){
          const raw = $("#discountInput").value || "0";
          const d = parseInt(raw,10);
          if(!isNaN(d) && d > 0) discount = Math.min(d,90);
        }

        let baseTotal = 0;
        let total = 0;
        const lines = [];
        entries.forEach(ent => {
          const item = state.trade.find(t => t.id === ent.id);
          if(!item || !supportsMode(item,mode)) return;
          const priceBase = (mode === "buy" ? item.buy : item.sell);
          if(priceBase == null || isNaN(priceBase)) return;

          let priceApplied = priceBase;
          if(mode === "sell" && discount > 0){
            priceApplied = Math.round(priceBase * (100 - discount) / 100);
          }

          const subBase = priceBase * ent.qty;
          const sub     = priceApplied * ent.qty;
          baseTotal += subBase;
          total     += sub;

          if(mode === "sell" && discount > 0){
            lines.push(item.item);
            lines.push("  QTY "+ent.qty+"  x  "+priceBase+" → "+priceApplied+"  =  "+sub+"  (discounted)");
          }else{
            lines.push(item.item);
            lines.push("  QTY "+ent.qty+"  x  "+priceBase+"  =  "+sub);
          }
        });

        if(total === 0){
          alert("Total is 0. Adjust quantities first.");
          return null;
        }

        let serialStr = String(state.receiptSerial);
        state.receiptSerial++;
        while(serialStr.length<4) serialStr = "0"+serialStr;

        const ts = stamp();
        const header = [];
        header.push("REC#: "+serialStr);
        header.push("ECOLOGIST TRADE RECEIPT");
        header.push("--------------------------------");
        header.push("TIME: "+ts);
        header.push("MODE: "+mode.toUpperCase()+" ("+(mode==="buy"?"BUYING FROM":"SELLING TO")+")");
        header.push("WITH: "+party);
        if(mode === "sell" && discount > 0){
          header.push("DISCOUNT: "+discount+"% (applied to SELL prices)");
        }
        header.push("");

        let txt = header.concat(lines).join("\n");
        if(mode === "sell" && discount > 0){
          txt += "\n\n--------------------------------";
          txt += "\nBASE TOTAL: "+baseTotal;
          txt += "\nDISCOUNTED TOTAL: "+total+"  (discount applied)";
        }else{
          txt += "\n\n--------------------------------\nTOTAL: "+total;
        }

        $("#receiptBox").textContent = txt;
        $("#receiptTotalTag").textContent = "TOTAL: "+total;

        if(mode === "buy"){
          $("#receiptHint").textContent = "Give "+total+" roubles to "+party+".";
        }else{
          if(discount > 0){
            $("#receiptHint").textContent = "Receive "+total+" roubles from "+party+" (discount "+discount+"%).";
          }else{
            $("#receiptHint").textContent = "Receive "+total+" roubles from "+party+".";
          }
        }

        const obj = {
          serial: serialStr,
          time: ts,
          party: party,
          mode: mode,
          total: total,
          discount: (mode==="sell"?discount:0),
          baseTotal: baseTotal,
          body: txt,
          _unsynced:true
        };
        state.lastReceipt = obj;

        return obj;
      }

      function sendReceiptToDesktop(){
        if(!state.lastReceipt || !state.lastReceipt.body || !state.lastReceipt.total){
          alert("Generate a receipt first.");
          return;
        }
        state.receiptsQueue.push(state.lastReceipt);
        updateBadges();
        markDirty("receipts");

        $("#receiptBox").textContent = "No receipt generated.";
        $("#receiptTotalTag").textContent = "TOTAL: 0";
        $("#receiptHint").textContent = "Set quantities and press GENERATE.";
        const party = $("#receiptParty");
        if(party) party.value = "";
        const disc = $("#discountInput");
        if(disc) disc.value = "";

        state.lastReceipt = null;
        state.tradeQty = {};
        renderTrade();
      }

      // Desktop helpers
      function bringToFront(win){
        state.winZ++;
        win.style.zIndex = state.winZ;
        const app = win.getAttribute("data-app");
        for(const k in state.desktopTasks){
          if(Object.prototype.hasOwnProperty.call(state.desktopTasks,k)){
            state.desktopTasks[k].classList.toggle("active", k === app);
          }
        }
      }

      function makeDraggable(win, handle){
        let dragging = false;
        let startX=0,startY=0,ox=0,oy=0;

        handle.addEventListener("mousedown", function(e){
          dragging = true;
          bringToFront(win);
          startX = e.clientX;
          startY = e.clientY;
          const r = win.getBoundingClientRect();
          ox = r.left;
          oy = r.top;
          e.preventDefault();
        });
        window.addEventListener("mousemove", function(e){
          if(!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          win.style.left = (ox+dx)+"px";
          win.style.top  = (oy+dy)+"px";
        });
        window.addEventListener("mouseup", function(){
          dragging = false;
        });
      }

      function addTaskButton(app, title){
        const bar = $("#taskBtns");
        const btn = document.createElement("div");
        btn.className = "taskBtn active";
        btn.textContent = title;
        btn.onclick = function(){
          const win = state.desktopWins[app];
          if(!win) return;
          win.classList.remove("hide");
          bringToFront(win);
        };
        bar.appendChild(btn);
        state.desktopTasks[app] = btn;
        for(const k in state.desktopTasks){
          if(Object.prototype.hasOwnProperty.call(state.desktopTasks,k)){
            state.desktopTasks[k].classList.toggle("active", k === app);
          }
        }
      }

      function closeWindow(app){
        const win = state.desktopWins[app];
        if(win) win.parentNode.removeChild(win);
        delete state.desktopWins[app];
        const t = state.desktopTasks[app];
        if(t) t.parentNode.removeChild(t);
        delete state.desktopTasks[app];
      }

      function openDesktopApp(app){
        if(!state.authenticated) return;
        setMode("desktop");
        if(state.desktopWins[app]){
          state.desktopWins[app].classList.remove("hide");
          bringToFront(state.desktopWins[app]);
          renderDesktopApp(app);
          return;
        }

        const titleMap = {
          reports:"Reports",
          receipts:"Receipts",
          intel:"Intel Encyclopaedia",
          personnel:"Personnel"
        };
        const win = document.createElement("div");
        win.className = "win";
        win.setAttribute("data-app", app);
        win.style.left = (180 + Math.random()*170) + "px";
        win.style.top  = (70  + Math.random()*120) + "px";
        win.style.zIndex = ++state.winZ;

        win.innerHTML =
          '<div class="winTitle">'+
            '<div class="titleText"><div class="miniIcon"></div><div>'+(titleMap[app]||app)+'</div></div>'+
            '<div class="winButtons">'+
              '<div class="winBtn" data-act="min">_</div>'+
              '<div class="winBtn" data-act="close">X</div>'+
            '</div>'+
          '</div>'+
          '<div class="winBody" id="winBody-'+app+'"></div>';

        makeDraggable(win, win.querySelector(".winTitle"));
        win.addEventListener("mousedown", function(){ bringToFront(win); });

        win.querySelector('[data-act="close"]').onclick = function(){ closeWindow(app); };
        win.querySelector('[data-act="min"]').onclick   = function(){
          win.classList.add("hide");
          for(const k in state.desktopTasks){
            if(Object.prototype.hasOwnProperty.call(state.desktopTasks,k)){
              state.desktopTasks[k].classList.remove("active");
            }
          }
        };

        $("#windows").appendChild(win);
        state.desktopWins[app] = win;
        addTaskButton(app, titleMap[app]||app);
        renderDesktopApp(app);
      }

      function renderDesktopApp(app){
        const body = $("#winBody-"+app);
        if(!body) return;

        if(app === "reports"){
          body.innerHTML =
            '<div class="w95Panel">'+
              '<div class="w95Label">Reports</div>'+
              '<div>Notes inbox + report editor – next pass (will pull from shared sheets).</div>'+
            '</div>';
        }else if(app === "receipts"){
          body.innerHTML =
            '<div class="w95Panel">'+
              '<div class="w95Label">Receipts</div>'+
              '<div class="w95List" id="deskReceiptList"></div>'+
              '<div style="height:10px"></div>'+
              '<textarea class="w95Field" id="deskReceiptBody" style="min-height:160px; resize:vertical;" readonly></textarea>'+
            '</div>';
          const list = $("#deskReceiptList");
          const box  = $("#deskReceiptBody");
          list.innerHTML = "";
          if(state.receiptsQueue.length === 0){
            list.innerHTML = '<div class="w95Item">No receipts.</div>';
          }else{
            const slice = state.receiptsQueue.slice().reverse();
            slice.forEach(r => {
              const div = document.createElement("div");
              div.className = "w95Item";
              div.innerHTML = "<b>"+escapeHtml(r.title||("Receipt "+(r.serial||"")))+"</b> — "+escapeHtml(r.time||"");
              div.onclick = function(){ box.value = r.body || ""; };
              list.appendChild(div);
            });
          }
        }else if(app === "intel"){
          body.innerHTML =
            '<div class="w95Panel">'+
              '<div class="w95Label">Intel Encyclopaedia</div>'+
              '<div>Placeholder for anomalies, artefacts, locations, etc. (sheet-backed later).</div>'+
            '</div>';
        }else if(app === "personnel"){
          body.innerHTML =
            '<div class="w95Panel">'+
              '<div class="w95Label">Personnel</div>'+
              '<div>Mirrors the shared stalker database from the sheet.</div>'+
            '</div>';
        }
      }

      function wirePDA(){
        // tiles
        $all(".appTile").forEach(t => {
          t.addEventListener("mousemove", e => {
            const rect = t.getBoundingClientRect();
            const x = ((e.clientX - rect.left)/rect.width)*100;
            const y = ((e.clientY - rect.top)/rect.height)*100;
            t.style.setProperty("--hx", x+"%");
            t.style.setProperty("--hy", y+"%");
          });
          t.addEventListener("mouseleave", () => {
            t.style.removeProperty("--hx");
            t.style.removeProperty("--hy");
          });
          t.addEventListener("click", () => {
            openApp(t.getAttribute("data-open"));
          });
        });

        // close
        $all("[data-close]").forEach(b => {
          b.addEventListener("click", () => {
            closeAllApps();
            const st = $("#pdaStatus");
            if(st) st.textContent = "READY";
          });
        });

        // global save buttons
        $all("[data-act='saveAll']").forEach(btn => {
          btn.addEventListener("click", syncToServer);
        });

        $("#btnGoDesk").onclick = () => setMode("desktop");

        $("#btnReboot").onclick = async () => {
          if(state.dirty.stalkers || state.dirty.trade || state.dirty.notes || state.dirty.receipts){
            if(!confirm("Discard unsaved local changes and reload from sheet?")) return;
            state.pendingStalkerEvents = [];
            state.pendingTradeEvents   = [];
          }
          clearDirty();
          await loadFromCloud(true);
        };

        $("#settingsBootBtn").onclick = () => runBoot();

        // Access seg (visual only)
        $("#accessSeg").onclick = function(e){
          const b = e.target;
          if(b.tagName !== "BUTTON") return;
          $all("#accessSeg button").forEach(x => x.classList.remove("active"));
          b.classList.add("active");
          setRole(b.getAttribute("data-role"));
        };

        // DB controls
        $("#dbSearch").oninput = renderDbList;
        $("#dbAddBtn").onclick = dbAddEntry;
        $("#dbApplyBtn").onclick = dbApply;
        $("#dbDeleteBtn").onclick = dbDelete;

        $("#dbStatusSeg").onclick = function(e){
          const b = e.target;
          if(b.tagName !== "BUTTON") return;
          state.dbStatusFilter = b.getAttribute("data-status");
          $all("#dbStatusSeg button").forEach(x => x.classList.toggle("active", x===b));
          renderDbList();
        };

        $("#nameSortBtn").onclick = function(){
          state.primarySort = "name";
          state.nameSortAsc = !state.nameSortAsc;
          $("#nameSortBtn").textContent = state.nameSortAsc ? "A→Z" : "Z→A";
          $("#nameSortBtn").classList.add("active");
          $("#repSortBtn").classList.remove("active");
          renderDbList();
        };
        $("#repSortBtn").onclick = function(){
          state.primarySort = "rep";
          state.repSortDesc = !state.repSortDesc;
          $("#repSortBtn").textContent = state.repSortDesc ? "REP↓" : "REP↑";
          $("#repSortBtn").classList.add("active");
          $("#nameSortBtn").classList.remove("active");
          renderDbList();
        };

        $("#pStatusSeg").onclick = function(e){
          const b = e.target;
          if(b.tagName !== "BUTTON") return;
          $all("#pStatusSeg button").forEach(x => x.classList.remove("active"));
          b.classList.add("active");
        };

        $("#repUp").onclick = function(){
          let cur = parseInt($("#pRep").value || "0",10) || 0;
          const next = cur + 100;
          $("#pRep").value = String(next);
          $("#repScorePreview").textContent = String(next);
          $("#repScorePreview").className = "repScore "+repClass(next);
        };
        $("#repDn").onclick = function(){
          let cur = parseInt($("#pRep").value || "0",10) || 0;
          const next = cur - 100;
          $("#pRep").value = String(next);
          $("#repScorePreview").textContent = String(next);
          $("#repScorePreview").className = "repScore "+repClass(next);
        };

        // notes
        $("#noteSendBtn").onclick = sendNoteToDesktop;

        // trade
        $("#tradeSearch").oninput = renderTrade;
        $("#tradeClearQtyBtn").onclick = clearTradeQty;
        $("#tradeAddItemBtn").onclick = startTradeAddRow;

        $("#tradeModeSeg").onclick = function(e){
          const b = e.target;
          if(b.tagName !== "BUTTON") return;
          setTradeMode(b.getAttribute("data-mode"));
        };

        $("#tradeGenerateBtn").onclick = () => { generateReceipt(); };
        $("#tradeSendReceiptBtn").onclick = sendReceiptToDesktop;
      }

      function wireDesktop(){
        $all(".icon", $("#desktop")).forEach(ic => {
          ic.ondblclick = function(){
            openDesktopApp(ic.getAttribute("data-open"));
          };
        });
      }

      function initClocks(){
        setInterval(() => {
          const el = $("#pdaClock");
          if(el) el.textContent = nowClock();
        }, 300);
        setInterval(() => {
          const el = $("#deskClock");
          if(el){
            const d = new Date();
            el.textContent = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
          }
        }, 1000);
      }

      function initUplinkMeter(){
        const barsEl = $("#uplinkBars");
        const pctEl  = $("#uplinkPercent");
        if(!barsEl || !pctEl) return;
        const patterns = ["▁▁▁▁","▂▁▁▁","▂▂▁▁"];
        function tick(){
          const r = Math.random();
          let level;
          if(r < 0.6) level = 1;
          else if(r < 0.85) level = 0;
          else level = 2;
          barsEl.textContent = patterns[level];
          const pct = 18 + Math.round(Math.random()*14);
          pctEl.textContent = pct+"%";
        }
        tick();
        setInterval(tick, 2200);
      }

      // --- API helpers (append-only backend) ---
      async function apiGetSheet(sheetName){
        try{
          const res = await fetch(UPLINK_URL + '?sheet=' + encodeURIComponent(sheetName),{
            method:'GET',
            headers:{'Accept':'application/json'}
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const json = await res.json();
          if(json.status !== 'ok'){
            showErrorOverlay('CONNECTION ERROR', (json.message || ('Sheet '+sheetName+' error')));
            setConnStatus("ERROR");
            return null;
          }
          hideErrorOverlay();
          setConnStatus("ONLINE");
          return json;
        }catch(err){
          console.error('apiGetSheet failed', sheetName, err);
          showErrorOverlay('CONNECTION ERROR', 'Sheet '+sheetName+': '+(err.message || 'Failed to load from uplink.'));
          setConnStatus("ERROR");
          return null;
        }
      }

      async function apiAppendRows(sheetName, rows){
        if(!rows || !rows.length) return {status:'ok', appended:0};
        try{
          const res = await fetch(UPLINK_URL, {
            method: 'POST',
            // Use text/plain so the browser does NOT do a CORS preflight OPTIONS request.
            // Apps Script will still see the JSON string in e.postData.contents.
            headers: { 'Content-Type': 'text/plain;charset=utf-8', 'Accept': 'application/json' },
            body: JSON.stringify({
              action: "appendRows",
              sheet: sheetName,
              rows: rows
            })
          });
      
          if (!res.ok) throw new Error('HTTP ' + res.status);
      
          const json = await res.json();
          if (json.status !== 'ok') {
            return { status: 'error', message: (json.message || 'Backend error') };
          }
      
          setConnStatus("ONLINE");
          return json;
        } catch (err) {
          console.error('apiAppendRows failed', sheetName, err);
          return { status: 'error', message: (err.message || 'Failed to save to uplink.') };
        }
      }


      function headerIndex(headers, name){
        const low = name.toLowerCase();
        for(let i=0;i<headers.length;i++){
          if(String(headers[i]).toLowerCase() === low) return i;
        }
        return -1;
      }

      function decodeStalkersLog(json){
        if(!json || !json.rows) return [];
        const h = json.headers || [];
        const iEv = headerIndex(h,'eventType');
        const iId = headerIndex(h,'id');
        const iName = headerIndex(h,'name');
        const iStatus = headerIndex(h,'status');
        const iRep = headerIndex(h,'rep');
        const iTask = headerIndex(h,'task');
        const iNotes = headerIndex(h,'notes');

        const map = new Map();
        json.rows.forEach(row => {
          const ev = String(iEv>=0 ? row[iEv] : "UPSERT").toUpperCase();
          const id = String(iId>=0 ? row[iId] : "").trim();
          if(!id) return;
          if(ev === "DELETE"){
            map.delete(id);
            return;
          }
          map.set(id,{
            id:id,
            name:   iName>=0   ? (row[iName] || "")   : "",
            status: iStatus>=0 ? (row[iStatus] || "") : "Collaborator",
            rep:    iRep>=0    ? (Number(row[iRep] || 0)||0) : 0,
            task:   iTask>=0   ? (row[iTask] || "")   : "",
            notes:  iNotes>=0  ? (row[iNotes] || "")  : ""
          });
        });

        const arr = Array.from(map.values());
        arr.sort((a,b) => {
          const an = (a.name||"").toLowerCase();
          const bn = (b.name||"").toLowerCase();
          if(an<bn) return -1;
          if(an>bn) return 1;
          return a.id.localeCompare(b.id);
        });
        return arr;
      }

      function decodeTradeLog(json){
        if(!json || !json.rows) return [];
        const h = json.headers || [];
        const iEv = headerIndex(h,'eventType');
        const iId = headerIndex(h,'id');
        const iCat = headerIndex(h,'category');
        const iItem = headerIndex(h,'item');
        const iBuy = headerIndex(h,'buyPrice');
        const iSell = headerIndex(h,'sellPrice');
        const iEnabled = headerIndex(h,'enabled');
        const iCanBuy = headerIndex(h,'canBuy');
        const iCanSell = headerIndex(h,'canSell');

        const map = new Map();
        json.rows.forEach(row => {
          const ev = String(iEv>=0 ? row[iEv] : "UPSERT").toUpperCase();
          const id = String(iId>=0 ? row[iId] : "").trim();
          if(!id) return;
          if(ev === "DELETE"){
            map.delete(id);
            return;
          }
          const buyVal  = iBuy>=0 ? row[iBuy] : "";
          const sellVal = iSell>=0 ? row[iSell] : "";
          const buy  = (buyVal === "" || buyVal == null) ? null : Number(buyVal);
          const sell = (sellVal === "" || sellVal == null) ? null : Number(sellVal);
          const enabled = String(iEnabled>=0 ? row[iEnabled] : "TRUE").toLowerCase() !== "false";
          const canBuy  = String(iCanBuy>=0 ? row[iCanBuy] : (buy != null ? "TRUE" : "FALSE")).toLowerCase() !== "false";
          const canSell = String(iCanSell>=0 ? row[iCanSell] : (sell!= null ? "TRUE" : "FALSE")).toLowerCase() !== "false";

          map.set(id,{
            id:id,
            cat:    iCat>=0 ? (row[iCat] || "") : "",
            item:   iItem>=0? (row[iItem]||"") : "",
            buy: buy,
            sell:sell,
            enabled:enabled,
            canBuy:canBuy,
            canSell:canSell
          });
        });

        return Array.from(map.values());
      }

      function decodeNotes(json){
        if(!json || !json.rows) return [];
        const h = json.headers || [];
        const iTs = headerIndex(h,'timestamp');
        const iTitle = headerIndex(h,'title');
        const iBody = headerIndex(h,'body');
        return json.rows.map(row => ({
          kind:'note',
          time:  iTs>=0 ? (row[iTs] || "") : "",
          title: iTitle>=0 ? (row[iTitle] || "Field Note") : "Field Note",
          body:  iBody>=0 ? (row[iBody] || "") : ""
        }));
      }

      function decodeReceipts(json){
        if(!json || !json.rows) return [];
        const h = json.headers || [];
        const iSerial   = headerIndex(h,'serial');
        const iTs       = headerIndex(h,'timestamp');
        const iParty    = headerIndex(h,'party');
        const iMode     = headerIndex(h,'mode');
        const iBase     = headerIndex(h,'baseTotal');
        const iDiscount = headerIndex(h,'discount');
        const iTotal    = headerIndex(h,'total');
        const iBody     = headerIndex(h,'body');

        return json.rows.map(row => {
          const serial = iSerial>=0 ? String(row[iSerial] || "") : "";
          const ts     = iTs>=0 ? (row[iTs] || "") : "";
          const title  = serial ? ("Receipt "+serial) : "Receipt";
          return {
            kind:'receipt',
            serial:serial,
            time:ts,
            party: iParty>=0 ? (row[iParty] || "") : "",
            mode:  iMode>=0 ? (row[iMode] || "") : "",
            baseTotal: iBase>=0 ? Number(row[iBase] || 0) : 0,
            discount:  iDiscount>=0 ? Number(row[iDiscount] || 0) : 0,
            total:     iTotal>=0 ? Number(row[iTotal] || 0) : 0,
            body: iBody>=0 ? (row[iBody] || "") : ""
          };
        });
      }

      async function loadAuthPinsFromSheet(){
        try{
          const data = await apiGetSheet("Auth");
          if(!data || data.status !== "ok") return;
          const h = data.headers || [];
          const iKey = headerIndex(h,'key');
          const iVal = headerIndex(h,'value');
          if(iKey === -1 || iVal === -1) return;

          data.rows.forEach(row => {
            const key = String(row[iKey] || "").trim();
            const val = String(row[iVal] || "").trim();
            if(key === "user_pin")  AUTH_PINS.user  = val;
            if(key === "admin_pin") AUTH_PINS.admin = val;
          });
        }catch(e){
          console.error("Failed to load Auth pins",e);
        }
      }

      async function loadFromCloud(showOverlay){
        if(showOverlay){
          showSyncOverlay('resync','Syncing with shared sheets...');
          $("#pdaStatus").textContent = "RESYNC";
        }
        const ses = $("#sessionBadge");
        if(ses) ses.textContent = "SESSION: SYNCING";

        const [stk,trd,nts,rec] = await Promise.all([
          apiGetSheet("Stalkers"),
          apiGetSheet("Trade"),
          apiGetSheet("Notes"),
          apiGetSheet("Receipts")
        ]);

        if(showOverlay) hideSyncOverlay();

        let anyCloud = false;

        if(stk && stk.rows){
          anyCloud = anyCloud || stk.rows.length>0;
          state.stalkers = decodeStalkersLog(stk);
        }else{
          state.stalkers = [];
        }

        if(trd && trd.rows){
          anyCloud = anyCloud || trd.rows.length>0;
          state.trade = decodeTradeLog(trd);
        }else{
          state.trade = [];
        }

        if(nts && nts.rows){
          anyCloud = anyCloud || nts.rows.length>0;
          state.notesQueue = decodeNotes(nts);
        }else{
          state.notesQueue = [];
        }

        if(rec && rec.rows){
          anyCloud = anyCloud || rec.rows.length>0;
          state.receiptsQueue = decodeReceipts(rec);
        }else{
          state.receiptsQueue = [];
        }

        state.pendingStalkerEvents = [];
        state.pendingTradeEvents   = [];
        state.tradeQty = {};
        state.tradeAddDraft = null;
        state.lastReceipt = null;

        clearDirty();

        if(anyCloud){
          if(ses) ses.textContent = "SESSION: CLOUD";
        }else{
          if(ses) ses.textContent = "SESSION: LOCAL";
        }

        rebuildPartyList();
        renderDbList();
        if(state.stalkers.length){
          state.selectedStalkerId = state.stalkers[0].id;
          loadProfile(state.selectedStalkerId);
        }else{
          state.selectedStalkerId = null;
          loadProfile(null);
        }

        renderNotes();
        renderTrade();
        updateBadges();

        const st = $("#pdaStatus");
        if(st) st.textContent = state.authenticated ? "READY" : "LOCKED";
      }

      async function syncToServer(){
        const hasSt = state.pendingStalkerEvents && state.pendingStalkerEvents.length>0;
        const hasTr = state.pendingTradeEvents   && state.pendingTradeEvents.length>0;
        const newNotes = state.notesQueue.filter(n => n._unsynced);
        const newRecs  = state.receiptsQueue.filter(r => r._unsynced);

        if(!hasSt && !hasTr && newNotes.length===0 && newRecs.length===0){
          const st = $("#pdaStatus");
          if(st){
            st.textContent = "NO CHANGES";
            setTimeout(()=>{ if(st.textContent==="NO CHANGES") st.textContent="READY"; }, 1000);
          }
          return;
        }

        showSyncOverlay('saving','Uploading changes...');
        const st = $("#pdaStatus");
        if(st) st.textContent = "SAVING...";

        const jobs = [];

        if(hasSt){
          const rowsSt = state.pendingStalkerEvents.map(ev => [
            stamp(),
            ev.eventType || "UPSERT",
            ev.data.id || "",
            ev.data.name || "",
            ev.data.status || "",
            Number(ev.data.rep || 0),
            ev.data.task || "",
            ev.data.notes || ""
          ]);
          jobs.push({sheet:"Stalkers", op: apiAppendRows("Stalkers", rowsSt)});
        }

        if(hasTr){
          const rowsTr = state.pendingTradeEvents.map(ev => [
            stamp(),
            ev.eventType || "UPSERT",
            ev.data.id || "",
            ev.data.cat || "",
            ev.data.item || "",
            ev.data.buy != null ? Number(ev.data.buy) : "",
            ev.data.sell!= null ? Number(ev.data.sell): "",
            ev.data.enabled ? "TRUE" : "FALSE",
            ev.data.canBuy ? "TRUE" : "FALSE",
            ev.data.canSell? "TRUE" : "FALSE"
          ]);
          jobs.push({sheet:"Trade", op: apiAppendRows("Trade", rowsTr)});
        }

        if(newNotes.length){
          const rowsN = newNotes.map(n => [
            n.time || stamp(),
            n.title || "",
            n.body || ""
          ]);
          jobs.push({sheet:"Notes", op: apiAppendRows("Notes", rowsN)});
        }

        if(newRecs.length){
          const rowsR = newRecs.map(r => [
            r.serial || "",
            r.time || stamp(),
            r.party || "",
            r.mode || "",
            r.baseTotal != null ? Number(r.baseTotal):"",
            r.discount != null ? Number(r.discount):"",
            r.total != null ? Number(r.total):"",
            r.body || ""
          ]);
          jobs.push({sheet:"Receipts", op: apiAppendRows("Receipts", rowsR)});
        }

        const results = await Promise.all(jobs.map(j => j.op));
        hideSyncOverlay();

        let ok = true;
        const errs = [];
        results.forEach((res, idx) => {
          if(!res || res.status !== 'ok'){
            ok = false;
            const sheet = jobs[idx].sheet;
            const msg = res && res.message ? res.message : "Unknown error";
            errs.push(sheet + ": " + msg);
          }
        });

        if(!ok){
          showErrorOverlay("SAVE ERROR", errs.join("\n"));
          if(st) st.textContent = "ERROR";
          return;
        }

        // success
        state.pendingStalkerEvents = [];
        state.pendingTradeEvents   = [];
        state.notesQueue.forEach(n => { delete n._unsynced; });
        state.receiptsQueue.forEach(r => { delete r._unsynced; });

        await loadFromCloud(false);
        clearDirty();
        if(st) st.textContent = "READY";
      }

      function runBoot(){
        const cover  = $("#bootCover");
        const log    = $("#bootLog");
        const fill   = $("#biosFill");
        const status = $("#biosStatus");
        if(!cover || !log || !fill || !status) return;

        $("#pdaStatus").textContent = "BOOT";
        closeAllApps();

        cover.style.display = "flex";
        log.textContent = "";
        fill.style.width = "0%";
        status.textContent = "INITIALIZING...";

        const lines = [
          "ECO FIELD PDA v0.7",
          "--------------------------------",
          "INIT DISPLAY BUS .......... [OK]",
          "LOAD UI SHELL ............. [OK]",
          "MOUNT SHARED REGISTRY ..... [OK]",
          "MOUNT NOTES QUEUE ......... [OK]",
          "MOUNT RECEIPT LEDGER ...... [OK]",
          "LINK DESKTOP .............. [OK]",
          "",
          "READY",
          ""
        ];

        const asciiArt =
"                                                                                                   \n\
                                                                                                   \n\
                                                                                                   \n\
                                                                                                   \n\
                                             +++++++                                              \n\
                                            +++    ++                                             \n\
                                         +++         +++                                          \n\
                                         ++           ++                                          \n\
                                        +++           ++++                                        \n\
                                        ++              ++                                        \n\
                                      ++++              +++                                       \n\
                                      ++                +++                                       \n\
                                   ++++++++              ++++                                     \n\
              +++++++++++          ++++++++              ++++           +++++++++++               \n\
            ++++          +++++++++++++++++               +++  +++++++++          +++             \n\
            +                  +++++++++++             ++++++++++++                ++             \n\
            +                      ++++++++++       +++++++++++               +++++++             \n\
            ++                      ++  ++++++++ ++++++++  ++                ++++++++++          \n\
             ++                   ++++      ++++++++       ++++              ++++++++++          \n\
             ++++                 ++++     +++++++++++     ++++               +++++++++          \n\
               ++                 +++   +++++++    ++++++    ++                ++++++             \n\
               +++++              ++++++++++         +++++++ ++              +++++                \n\
                 +++++            ++++++     +++++++     ++++++             ++++                  \n\
                  +++++          +++++    +++++++++++++    ++++++        ++++++                   \n\
                    +++++      +++++     +++++++++++++++    +++++++     +++++                     \n\
                      +++++  +++++++    +++++++++++++++++   +++++++++++++++                       \n\
                         +++++++ +++    +++++++++++++++++   +++  ++++++++                         \n\
                          ++++++  ++    +++++++++++++++++   +++   ++++++                          \n\
                       +++++++++++++    +++++++++++++++++   +++ ++++++++++                        \n\
                     +++++     +++++     +++++++++++++++    ++++++     +++++                      \n\
                    +++++        +++++    +++++++++++++    +++++        ++++++                   \n\
                  +++++           ++++++     +++++++     ++++++           ++++++                 \n\
                +++++             ++  +++++            ++++  ++             +++++                \n\
               ++++               ++    ++++++++   ++++++    ++                +++               \n\
               ++                 ++++      +++++++++++    ++++                 ++               \n\
             +++                  ++++        +++++        ++++                 ++++             \n\
            +++                     ++  +++++++   ++++++   ++                     ++             \n\
            ++                      +++++++          ++++++++                     +++            \n\
            ++                    ++++++                 ++++++                     +            \n\
            ++      ++++++  ++++++++++                     + ++++++++               +            \n\
             ++++++++++++++++++      +                   ++++     ++++++++++     +++             \n\
              ++ +++++++++++         +++                 ++++          ++++++++++++              \n\
                   +++++++           +++               ++++                                       \n\
                     ++++             ++              +++++++                                     \n\
                                      ++++          +++++++++++                                   \n\
                                        ++          +++++++++++                                   \n\
                                        +++           +++++++                                     \n\
                                         ++++       +++                                           \n\
                                           +++     +++                                            \n\
                                             +++++++                                              \n\
                                                                                                   \n\
                                                                                                   \n\
                                                                                                   \n\
                                                                                                   ";

        let i = 0;
        function stepLines(){
          if(i < lines.length){
            log.textContent += lines[i] + "\n";
            i++;
            setTimeout(stepLines, 55);
          }else{
            log.textContent += asciiArt + "\n";
            let p = 0;
            function stepBar(){
              if(p >= 100){
                setTimeout(function(){
                  cover.style.display = "none";
                  loadFromCloud(true).then(function(){
                    showAuthOverlay();
                  });
                }, 250);
                return;
              }
              p += 10 + Math.floor(Math.random()*15);
              if(p > 100) p = 100;
              fill.style.width = p + "%";
              if(p < 40) status.textContent = "LOADING MODULES...";
              else if(p < 80) status.textContent = "LINKING SERVICES...";
              else status.textContent = "FINALIZING...";
              setTimeout(stepBar, 70);
            }
            stepBar();
          }
        }
        stepLines();
      }

      function init(){
        $("#btnPDA").onclick  = () => setMode("pda");
        $("#btnDESK").onclick = () => setMode("desktop");

        window.addEventListener("keydown", function(e){
          if(e.ctrlKey && e.key === "1"){ setMode("pda"); }
          if(e.ctrlKey && e.key === "2"){ setMode("desktop"); }
        });

        const errOk = $("#errorOkBtn");
        if(errOk) errOk.onclick = hideErrorOverlay;

        $("#authBtn").onclick = handleAuth;
        $("#authPin").addEventListener("keydown", function(e){
          if(e.key === "Enter") handleAuth();
        });

        wirePDA();
        wireDesktop();
        initClocks();
        initUplinkMeter();

        setMode("pda");
        setRole(state.role);
        updateBadges();
        renderDbList();
        renderNotes();
        renderTrade();

        // Boot immediately so home never shows first
        runBoot();
        // Load pins in the background while boot + sync happen
        loadAuthPinsFromSheet();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>

